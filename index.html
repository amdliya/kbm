<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdeM's Core - Sistem Manajemen Pembelajaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 400px;
        }
        .main-app {
            display: none;
        }
        .main-app.authenticated {
            display: flex;
        }
        .sidebar-item:hover {
            background-color: #a855f7;
            color: white;
        }
        .sidebar-item.active {
            background-color: #7c3aed;
            color: white;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .class-card {
            transition: all 0.3s ease;
        }
        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .view-toggle button.active {
            background-color: #7c3aed;
            color: white;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .student-row:hover {
            background-color: #f8fafc;
        }
        .attendance-grid {
            display: grid;
            grid-template-columns: 2fr repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            align-items: center;
        }
        .attendance-header {
            background-color: #f1f5f9;
            padding: 8px;
            font-weight: 600;
            text-align: center;
            border-radius: 4px;
        }
        .attendance-cell {
            padding: 4px;
            text-align: center;
        }
        .attendance-status {
            width: 100%;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            font-size: 12px;
        }
        .status-hadir { background-color: #dcfce7; color: #166534; }
        .status-sakit { background-color: #fef3c7; color: #92400e; }
        .status-izin { background-color: #dbeafe; color: #1e40af; }
        .status-alpha { background-color: #fecaca; color: #dc2626; }
        
        /* Sidebar collapse styles */
        #sidebar.collapsed {
            width: 80px;
        }
        
        #sidebar.collapsed .menu-text {
            display: none;
        }
        
        #sidebar.collapsed #sidebarTitle {
            display: none;
        }
        
        #sidebar.collapsed .sidebar-item {
            justify-content: center;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        #sidebar.collapsed .menu-icon {
            font-size: 1.25rem;
        }
        
        /* Tooltip for collapsed menu items */
        .sidebar-item.tooltip-enabled {
            position: relative;
        }
        
        .sidebar-item.tooltip-enabled:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 1000;
            margin-left: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-item.tooltip-enabled:hover::before {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #1f2937;
            z-index: 1000;
            margin-left: 2px;
        }
    </style>
</head>
<body class="bg-purple-50 h-full">
    <!-- Login Form -->
    <div id="loginContainer" class="login-container">
        <div class="login-form">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">AdeM's Core</h1>
                <p class="text-gray-600">Sistem Manajemen Pembelajaran</p>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                           placeholder="Masukkan username">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                           placeholder="Masukkan password">
                </div>
                
                <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm">
                    Username atau password salah!
                </div>
                
                <button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors font-medium">
                    üîê Masuk
                </button>
            </form>
            

        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app flex h-full">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-white shadow-lg flex flex-col h-full transition-all duration-300">
            <div class="p-6 border-b flex items-center justify-between">
                <h1 id="sidebarTitle" class="text-xl font-bold text-gray-800">AdeM's Core</h1>
                <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Sembunyikan/Tampilkan Menu">
                    <span id="toggleIcon">‚óÄ</span>
                </button>
            </div>
            <nav class="mt-6 flex flex-col flex-1">
                <div class="px-4 space-y-2 flex-1">
                    <button onclick="showSection('dashboard')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">üìä</span>
                        <span class="menu-text">Dashboard</span>
                    </button>
                    <button onclick="showSection('kelas')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">üè´</span>
                        <span class="menu-text">Kelas</span>
                    </button>
                    <button onclick="showSection('siswa')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">üë•</span>
                        <span class="menu-text">Siswa</span>
                    </button>
                    <button onclick="showSection('presensi')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">‚úÖ</span>
                        <span class="menu-text">Input Presensi</span>
                    </button>
                    <button onclick="showSection('rekap')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">üìã</span>
                        <span class="menu-text">Rekap Presensi</span>
                    </button>
                    <button onclick="showSection('nilai')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">üìä</span>
                        <span class="menu-text">Input Nilai</span>
                    </button>
                    <button onclick="showSection('rekapnilai')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">üìà</span>
                        <span class="menu-text">Rekap Nilai</span>
                    </button>
                    <button onclick="showSection('jurnal')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">üìù</span>
                        <span class="menu-text">Jurnal</span>
                    </button>
                    <button onclick="showSection('pengaturan')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">‚öôÔ∏è</span>
                        <span class="menu-text">Pengaturan</span>
                    </button>
                </div>
                
                <!-- Logout Button - Separated at bottom -->
                <div class="px-4 pb-4 mt-6 border-t border-gray-200 pt-4">
                    <button onclick="handleLogout()" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-red-700 hover:bg-red-500 hover:text-white transition-colors flex items-center gap-3">
                        <span class="menu-icon">üö™</span>
                        <span class="menu-text">Keluar</span>
                    </button>
                </div>
            </nav>
        </div>
        


        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Dashboard</h2>
                
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-400">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total Kelas</p>
                                <p class="text-2xl font-bold text-gray-800" id="totalKelas">0</p>
                            </div>
                            <div class="text-purple-400 text-3xl">üè´</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total Siswa</p>
                                <p class="text-2xl font-bold text-gray-800" id="totalSiswa">0</p>
                            </div>
                            <div class="text-purple-300 text-3xl">üë•</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Presensi Hari Ini</p>
                                <p class="text-2xl font-bold text-gray-800" id="presensiHariIni">0</p>
                            </div>
                            <div class="text-purple-500 text-3xl">‚úÖ</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-600">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Jurnal Hari Ini</p>
                                <p class="text-2xl font-bold text-gray-800" id="jurnalHariIni">0</p>
                            </div>
                            <div class="text-purple-600 text-3xl">üìù</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gender Distribution Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">Distribusi Jenis Kelamin per Kelas</h3>
                            <div class="text-2xl">üë•</div>
                        </div>
                        <div class="h-80 overflow-x-auto">
                            <canvas id="genderChart" class="w-full h-full"></canvas>
                        </div>
                        <div class="flex justify-center mt-4 gap-6">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-500 rounded"></div>
                                <span class="text-sm text-gray-600">Laki-laki</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-pink-500 rounded"></div>
                                <span class="text-sm text-gray-600">Perempuan</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top Grades List -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">3 Nilai Tertinggi per Kelas</h3>
                            <div class="text-2xl">üèÜ</div>
                        </div>
                        <div class="mb-4">
                            <label for="topGradesClassFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas:</label>
                            <select id="topGradesClassFilter" onchange="updateTopGradesList()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div class="h-80 overflow-y-auto">
                            <div id="topGradesList" class="space-y-3">
                                <div class="text-center text-gray-500 py-8">
                                    Pilih kelas untuk melihat 3 nilai tertinggi
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kelas Section -->
            <div id="kelas" class="content-section p-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">Manajemen Kelas</h2>
                    <div class="flex gap-4">
                        <div class="view-toggle flex bg-gray-200 rounded-lg p-1">
                            <button onclick="toggleView('thumbnail')" class="px-4 py-2 rounded-md transition-colors" id="thumbnailBtn">
                                üì± Thumbnail
                            </button>
                            <button onclick="toggleView('list')" class="px-4 py-2 rounded-md transition-colors active" id="listBtn">
                                üìã List
                            </button>
                        </div>
                        <button onclick="showAddClassForm()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            ‚ûï Tambah Kelas
                        </button>
                    </div>
                </div>

                <!-- Add Class Form -->
                <div id="addClassForm" class="bg-white p-6 rounded-xl shadow-md mb-6 hidden">
                    <h3 class="text-xl font-semibold mb-4">Tambah Kelas Baru</h3>
                    <form onsubmit="addClass(event)" class="space-y-4">
                        <div>
                            <label for="newClassName" class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" id="newClassName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Contoh: X IPA 1">
                        </div>
                        <div>
                            <label for="newClassDescription" class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea id="newClassDescription" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" rows="3" placeholder="Deskripsi kelas (opsional)"></textarea>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                üíæ Simpan
                            </button>
                            <button type="button" onclick="hideAddClassForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                ‚ùå Batal
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Thumbnail View -->
                <div id="thumbnailView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                    <!-- Classes will be dynamically added here -->
                </div>

                <!-- List View -->
                <div id="listView" class="bg-white rounded-xl shadow-md">
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Nama Kelas</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Deskripsi</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Jumlah Siswa</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="classListBody">
                                    <!-- Classes will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Siswa Section -->
            <div id="siswa" class="content-section p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Manajemen Siswa</h2>
                
                <!-- CSV Import/Export Section -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Import/Export Data Siswa</h3>
                        <div class="flex gap-3">
                            <button onclick="downloadStudentCSVTemplate()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                üì• Download Template CSV
                            </button>
                            <button onclick="document.getElementById('studentCSVUpload').click()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                üì§ Upload CSV Siswa
                            </button>
                            <input type="file" id="studentCSVUpload" accept=".csv" style="display: none;" onchange="uploadStudentCSV(event)">
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">
                        Download template CSV untuk format yang benar, lalu upload file CSV yang sudah diisi untuk menambah banyak siswa sekaligus.
                    </p>
                </div>

                <!-- Add Student Form -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">Tambah Siswa Baru</h3>
                    <form onsubmit="addStudent(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label>
                            <input type="text" id="studentName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nama lengkap siswa">
                        </div>
                        <div>
                            <label for="studentNIS" class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                            <input type="text" id="studentNIS" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nomor Induk Siswa Nasional">
                        </div>
                        <div>
                            <label for="studentClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="studentClass" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div>
                            <label for="studentGender" class="block text-sm font-medium text-gray-700 mb-2">JK</label>
                            <select id="studentGender" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üíæ Tambah Siswa
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Students List -->
                <div class="bg-white rounded-xl shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Daftar Siswa</h3>
                            <div class="flex items-center gap-4">
                                <label for="filterStudentClass" class="text-sm font-medium text-gray-700">Filter Kelas:</label>
                                <select id="filterStudentClass" onchange="filterStudentsByClass()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Semua Kelas</option>
                                </select>
                                <button onclick="downloadStudentsByClass()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                    üì• Unduh CSV
                                </button>
                                <button onclick="deleteStudentsByClass()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                                    üóëÔ∏è Hapus Kelas
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search Bar -->
                        <div class="mb-4">
                            <div class="relative">
                                <input type="text" id="searchStudentName" onkeyup="searchStudents()" placeholder="üîç Cari nama siswa..." class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">üîç</span>
                                </div>
                                <button onclick="clearStudentSearch()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600" title="Hapus pencarian">
                                    <span id="clearSearchBtn" class="hidden">‚ùå</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="table-container">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">NISN</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Nama</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Kelas</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">JK</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsList">
                                    <!-- Students will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Presensi Section -->
            <div id="presensi" class="content-section p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Input Presensi</h2>
                
                <!-- CSV Upload Section -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Upload Presensi CSV</h3>
                        <div class="flex gap-3">
                            <button onclick="downloadAttendanceCSVTemplate()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                üì• Download Template CSV
                            </button>
                            <button onclick="document.getElementById('attendanceCSVUpload').click()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                üì§ Upload CSV Presensi
                            </button>
                            <input type="file" id="attendanceCSVUpload" accept=".csv" style="display: none;" onchange="uploadAttendanceCSV(event)">
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">
                        Download template CSV untuk format yang benar, lalu upload file CSV yang sudah diisi untuk input presensi banyak siswa sekaligus.
                    </p>
                </div>

                <!-- Class Selection -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="attendanceClass" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                            <select id="attendanceClass" onchange="loadStudentsForAttendance()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div>
                            <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="attendanceDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <button onclick="saveAttendance()" class="w-full bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üíæ Simpan Presensi
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Attendance List -->
                <div id="attendanceContainer" class="bg-white rounded-xl shadow-md hidden">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold">Daftar Presensi</h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4" id="attendanceList">
                            <!-- Attendance items will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Attendance History -->
                <div class="bg-white rounded-xl shadow-md mt-6">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold">Riwayat Presensi Terbaru</h3>
                            <div class="flex items-center gap-4">
                                <label for="historyClassFilter" class="text-sm font-medium text-gray-700">Filter Kelas:</label>
                                <select id="historyClassFilter" onchange="filterAttendanceHistory()" class="px-3 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Semua Kelas</option>
                                </select>
                                <button onclick="refreshAttendanceHistory()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors text-sm">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Tanggal</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Kelas</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Jumlah Siswa</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Hadir</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Sakit</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Izin</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Alpha</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Waktu Input</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">%</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceHistoryList">
                                    <!-- Attendance history will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination Container -->
                        <div id="historyPagination">
                            <!-- Pagination will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rekap Presensi Section -->
            <div id="rekap" class="content-section p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Rekap Presensi</h2>
                
                <!-- Filter Section -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="rekapClass" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                            <select id="rekapClass" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div>
                            <label for="rekapStartDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="rekapStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="rekapEndDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="rekapEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <button onclick="generateRekap()" class="w-full bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                üìä Generate Rekap
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Rekap Results -->
                <div id="rekapResults" class="bg-white rounded-xl shadow-md hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold">Hasil Rekap Presensi</h3>
                            <div class="flex gap-2">
                                <button onclick="exportRekap()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    üì• Export CSV
                                </button>
                                <button onclick="showDeleteAttendanceOptions()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                    üóëÔ∏è Hapus Presensi
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <div id="rekapTable">
                                <!-- Rekap table will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jurnal Section -->
            <div id="jurnal" class="content-section p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Jurnal Pembelajaran</h2>
                
                <!-- Add Journal Form -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">Tambah Jurnal Baru</h3>
                    <form onsubmit="addJournal(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="jurnalClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="jurnalClass" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label for="jurnalDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="jurnalDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="jurnalSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                            <input type="text" id="jurnalSubject" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nama mata pelajaran">
                        </div>
                        <div>
                            <label for="jurnalMaterial" class="block text-sm font-medium text-gray-700 mb-2">Materi Pembelajaran</label>
                            <textarea id="jurnalMaterial" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4" placeholder="Deskripsi materi yang diajarkan"></textarea>
                        </div>
                        <div>
                            <label for="jurnalNotes" class="block text-sm font-medium text-gray-700 mb-2">Catatan Tambahan</label>
                            <textarea id="jurnalNotes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Catatan atau kendala (opsional)"></textarea>
                        </div>
                        <div>
                            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üíæ Simpan Jurnal
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Journal List -->
                <div class="bg-white rounded-xl shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Daftar Jurnal</h3>
                            <div class="flex items-center gap-4">
                                <label for="filterJurnalStartDate" class="text-sm font-medium text-gray-700">Dari:</label>
                                <input type="date" id="filterJurnalStartDate" onchange="filterJournalByDate()" class="px-3 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <label for="filterJurnalEndDate" class="text-sm font-medium text-gray-700">Sampai:</label>
                                <input type="date" id="filterJurnalEndDate" onchange="filterJournalByDate()" class="px-3 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button onclick="clearJournalFilter()" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 transition-colors text-sm">
                                    üîÑ Reset
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Tanggal</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Kelas</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Mata Pelajaran</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Materi</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Catatan</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="journalList">
                                    <!-- Journal entries will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Nilai Section -->
            <div id="nilai" class="content-section p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Input Nilai</h2>
                
                <!-- Assessment Form -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">Buat Penilaian Baru</h3>
                    <form onsubmit="createAssessment(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nilaiClass" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                                <select id="nilaiClass" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label for="assessmentType" class="block text-sm font-medium text-gray-700 mb-2">Tipe Penilaian</label>
                                <select id="assessmentType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Tipe Penilaian</option>
                                    <option value="TP">TP (Tugas Proyek)</option>
                                    <option value="LM">LM (Asesmen Lingkup Materi)</option>
                                    <option value="STS">STS (Sumatif Tengah Semester)</option>
                                    <option value="SAS">SAS (Sumatif Akhir Semester)</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="assessmentName" class="block text-sm font-medium text-gray-700 mb-2">Nama Penilaian</label>
                            <input type="text" id="assessmentName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama penilaian">
                        </div>
                        <div>
                            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üíæ Buat Penilaian
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Assessment List -->
                <div class="bg-white rounded-xl shadow-md mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold">Daftar Penilaian</h3>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4" id="assessmentList">
                            <!-- Assessment entries will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Grade Input Form -->
                <div id="gradeInputForm" class="bg-white rounded-xl shadow-md hidden">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold" id="gradeFormTitle">Input Nilai</h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4" id="gradeInputList">
                            <!-- Grade input fields will be dynamically added here -->
                        </div>
                        <div class="mt-6 flex gap-4">
                            <button onclick="saveGrades()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üíæ Simpan Nilai
                            </button>
                            <button onclick="hideGradeForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                ‚ùå Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rekap Nilai Section -->
            <div id="rekapnilai" class="content-section p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Rekap Nilai</h2>
                
                <!-- Filter Section -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="rekapNilaiClass" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                            <select id="rekapNilaiClass" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div>
                            <label for="rekapNilaiType" class="block text-sm font-medium text-gray-700 mb-2">Tipe Penilaian</label>
                            <select id="rekapNilaiType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Semua Tipe</option>
                                <option value="TP">TP (Tugas Proyek)</option>
                                <option value="LM">LM (Asesmen Lingkup Materi)</option>
                                <option value="STS">STS (Sumatif Tengah Semester)</option>
                                <option value="SAS">SAS (Sumatif Akhir Semester)</option>
                            </select>
                        </div>
                        <div>
                            <button onclick="generateRekapNilai()" class="w-full bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                üìä Generate Rekap
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Rekap Results -->
                <div id="rekapNilaiResults" class="bg-white rounded-xl shadow-md hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold">Hasil Rekap Nilai</h3>
                            <div class="flex gap-2">
                                <button onclick="exportRekapNilai()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    üì• Export Excel
                                </button>
                                <button onclick="calculateFinalGrades()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    üßÆ Hitung Nilai Akhir
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <div id="rekapNilaiTable">
                                <!-- Rekap table will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Final Grades Section -->
                <div id="finalGradesSection" class="bg-white rounded-xl shadow-md mt-6 hidden">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold">Nilai Akhir dengan Bobot</h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Bobot: TP (${weightSettings.TP}%) ‚Ä¢ LM (${weightSettings.LM}%) ‚Ä¢ STS (${weightSettings.STS}%) ‚Ä¢ SAS (${weightSettings.SAS}%)
                        </p>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <div id="finalGradesTable">
                                <!-- Final grades table will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pengaturan Section -->
            <div id="pengaturan" class="content-section p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Pengaturan</h2>
                
                <!-- Bobot Nilai Settings -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">Pengaturan Bobot Nilai</h3>
                    <form onsubmit="saveWeightSettings(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="weightTP" class="block text-sm font-medium text-gray-700 mb-2">Bobot TP (%)</label>
                                <input type="number" id="weightTP" min="0" max="100" value="30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="weightLM" class="block text-sm font-medium text-gray-700 mb-2">Bobot LM (%)</label>
                                <input type="number" id="weightLM" min="0" max="100" value="30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="weightSTS" class="block text-sm font-medium text-gray-700 mb-2">Bobot STS (%)</label>
                                <input type="number" id="weightSTS" min="0" max="100" value="20" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="weightSAS" class="block text-sm font-medium text-gray-700 mb-2">Bobot SAS (%)</label>
                                <input type="number" id="weightSAS" min="0" max="100" value="20" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>Total bobot: <span id="totalWeight">100</span>%</p>
                        </div>
                        <div>
                            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üíæ Simpan Pengaturan
                            </button>
                        </div>
                    </form>
                </div>



                <!-- Predikat Nilai Settings -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">Pengaturan Predikat Nilai</h3>
                    <form onsubmit="savePredicateSettings(event)" class="space-y-4">
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Predikat A - Sangat Baik</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="predicateA_min" min="0" max="100" value="90" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <span class="text-gray-500">-</span>
                                        <input type="number" id="predicateA_max" min="0" max="100" value="100" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Predikat B - Baik</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="predicateB_min" min="0" max="100" value="80" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <span class="text-gray-500">-</span>
                                        <input type="number" id="predicateB_max" min="0" max="100" value="89" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Predikat C - Cukup</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="predicateC_min" min="0" max="100" value="70" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <span class="text-gray-500">-</span>
                                        <input type="number" id="predicateC_max" min="0" max="100" value="79" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Predikat D - Perlu Bimbingan</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="predicateD_min" min="0" max="100" value="0" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <span class="text-gray-500">-</span>
                                        <input type="number" id="predicateD_max" min="0" max="100" value="69" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>üí° Pastikan rentang nilai tidak tumpang tindih dan mencakup seluruh rentang 0-100</p>
                        </div>
                        <div>
                            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üíæ Simpan Predikat
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Profile Settings -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">Pengaturan Profil</h3>
                    
                    <!-- Website Name Settings -->
                    <div class="mb-6 p-4 bg-green-50 rounded-lg">
                        <h4 class="font-medium text-green-800 mb-4">Nama Website</h4>
                        <form onsubmit="changeWebsiteName(event)" class="space-y-4">
                            <div>
                                <label for="currentWebsiteName" class="block text-sm font-medium text-gray-700 mb-2">Nama Website Saat Ini</label>
                                <input type="text" id="currentWebsiteName" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600" value="AdeM's Core">
                            </div>
                            <div>
                                <label for="newWebsiteName" class="block text-sm font-medium text-gray-700 mb-2">Nama Website Baru</label>
                                <input type="text" id="newWebsiteName" required minlength="3" maxlength="50" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Masukkan nama website baru">
                            </div>
                            <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                                <p><strong>üí° Info:</strong> Nama website akan muncul di header, login page, dan seluruh sistem.</p>
                            </div>
                            <div>
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    üè∑Ô∏è Ubah Nama Website
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Login Settings -->
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-800 mb-4">Pengaturan Login</h4>
                        
                        <!-- Current Credentials Display -->
                        <div class="mb-6 p-4 bg-white rounded-lg border border-blue-200">
                            <h5 class="font-medium text-blue-700 mb-2">Kredensial Saat Ini</h5>
                            <div class="space-y-2 text-sm">
                                <div><strong>Username:</strong> <span id="currentUsername" class="font-mono bg-blue-100 px-2 py-1 rounded">admin</span></div>
                                <div><strong>Password:</strong> <span class="font-mono bg-blue-100 px-2 py-1 rounded">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
                            </div>
                        </div>
                        
                        <!-- Change Credentials Form -->
                        <form onsubmit="changeLoginCredentials(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-2">Username Baru</label>
                                    <input type="text" id="newUsername" required minlength="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Minimal 3 karakter">
                                </div>
                                <div>
                                    <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">Password Baru</label>
                                    <input type="password" id="newPassword" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Minimal 6 karakter">
                                </div>
                            </div>
                            <div>
                                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Password Baru</label>
                                <input type="password" id="confirmPassword" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ulangi password baru">
                            </div>
                            <div class="text-sm text-gray-600 bg-yellow-50 p-3 rounded-lg">
                                <p><strong>‚ö†Ô∏è Peringatan:</strong> Setelah mengubah kredensial, Anda akan otomatis logout dan harus login kembali dengan kredensial baru.</p>
                            </div>
                            <div>
                                <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                    üîê Ubah Kredensial Login
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Other Settings -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Pengaturan Lainnya</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                            <div>
                                <h4 class="font-medium">Backup Data</h4>
                                <p class="text-sm text-gray-600">Backup semua data sistem</p>
                            </div>
                            <button onclick="backupData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                üíæ Backup
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                            <div>
                                <h4 class="font-medium">Restore Data</h4>
                                <p class="text-sm text-gray-600">Pulihkan data dari file backup JSON</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('restoreFileInput').click()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    üì§ Pilih File
                                </button>
                                <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="restoreData(event)">
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                            <div>
                                <h4 class="font-medium">Reset Data</h4>
                                <p class="text-sm text-gray-600">Hapus semua data (tidak dapat dibatalkan)</p>
                            </div>
                            <button onclick="resetData()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                üóëÔ∏è Reset
                            </button>
                        </div>
                    </div>
                    
                    <!-- Developer Information -->
                    <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                        <p class="text-sm text-gray-600">
                            Dikembangkan oleh <span class="font-medium text-purple-600">Ade Maulana Dliya</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication settings
        let AUTH_CREDENTIALS = {
            username: 'admin',
            password: 'admin123'
        };

        // Global data storage
        let classesData = [];
        let studentsData = [];
        let attendanceData = [];
        let attendanceHistoryData = []; // Track attendance sessions
        let journalData = [];
        let assessmentData = [];
        let gradesData = [];
        let weightSettings = {
            TP: 30,
            LM: 30,
            STS: 20,
            SAS: 20
        };
        
        // Website settings
        let websiteSettings = {
            name: "AdeM's Core"
        };
        
        let predicateSettings = {
            A: { min: 90, max: 100, label: 'Sangat Baik' },
            B: { min: 80, max: 89, label: 'Baik' },
            C: { min: 70, max: 79, label: 'Cukup' },
            D: { min: 0, max: 69, label: 'Perlu Bimbingan' }
        };

        // Authentication functions
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // Hide previous error
            errorDiv.classList.add('hidden');
            
            // Check credentials
            if (username === AUTH_CREDENTIALS.username && password === AUTH_CREDENTIALS.password) {
                // Store login session
                sessionStorage.setItem('isAuthenticated', 'true');
                sessionStorage.setItem('loginTime', new Date().toISOString());
                
                // Show main app
                showMainApp();
                
                // Clear form
                document.getElementById('loginForm').reset();
            } else {
                // Show error
                errorDiv.classList.remove('hidden');
                
                // Clear password field
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        }

        function handleLogout() {
            const confirmLogout = confirm('Apakah Anda yakin ingin keluar?');
            if (confirmLogout) {
                // Clear session
                sessionStorage.removeItem('isAuthenticated');
                sessionStorage.removeItem('loginTime');
                
                // Show login form
                showLoginForm();
            }
        }

        function showMainApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainApp').classList.add('authenticated');
            
            // Initialize app after login
            initApp();
            
            // Initialize sidebar state
            initSidebarState();
            
            // Update credentials display
            updateCurrentCredentialsDisplay();
            
            // Update website name display
            updateWebsiteNameDisplay();
        }

        function showLoginForm() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainApp').classList.remove('authenticated');
            
            // Focus on username field
            setTimeout(() => {
                document.getElementById('username').focus();
            }, 100);
        }

        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('isAuthenticated');
            const loginTime = sessionStorage.getItem('loginTime');
            
            // Check if session is valid (24 hours)
            if (isAuthenticated && loginTime) {
                const loginDate = new Date(loginTime);
                const now = new Date();
                const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
                
                if (hoursDiff < 24) {
                    showMainApp();
                    return;
                }
            }
            
            // Show login form if not authenticated or session expired
            showLoginForm();
        }
        


        // Initialize the application
        function initApp() {
            // Set today's date for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('jurnalDate').value = today;
            
            // Load saved data from localStorage
            loadData();
            
            // Update dashboard
            updateDashboard();
            
            // Update all class options
            updateAllClassOptions();
            
            // Update attendance history
            updateAttendanceHistoryOptions();
            updateAttendanceHistory();
            
            // Update weight display
            updateWeightDisplay();
        }

        // Load data from localStorage
        function loadData() {
            const savedClasses = localStorage.getItem('classesData');
            if (savedClasses) {
                classesData = JSON.parse(savedClasses);
                updateClassViews();
            }

            const savedStudents = localStorage.getItem('studentsData');
            if (savedStudents) {
                studentsData = JSON.parse(savedStudents);
                updateStudentsList();
            }

            const savedAttendance = localStorage.getItem('attendanceData');
            if (savedAttendance) {
                attendanceData = JSON.parse(savedAttendance);
            }

            const savedJournal = localStorage.getItem('journalData');
            if (savedJournal) {
                journalData = JSON.parse(savedJournal);
                updateJournalList();
            }

            const savedAssessment = localStorage.getItem('assessmentData');
            if (savedAssessment) {
                assessmentData = JSON.parse(savedAssessment);
                updateAssessmentList();
            }

            const savedGrades = localStorage.getItem('gradesData');
            if (savedGrades) {
                gradesData = JSON.parse(savedGrades);
            }

            const savedAttendanceHistory = localStorage.getItem('attendanceHistoryData');
            if (savedAttendanceHistory) {
                attendanceHistoryData = JSON.parse(savedAttendanceHistory);
            }

            const savedWeights = localStorage.getItem('weightSettings');
            if (savedWeights) {
                weightSettings = JSON.parse(savedWeights);
                document.getElementById('weightTP').value = weightSettings.TP;
                document.getElementById('weightLM').value = weightSettings.LM;
                document.getElementById('weightSTS').value = weightSettings.STS;
                document.getElementById('weightSAS').value = weightSettings.SAS;
            }

            const savedPredicates = localStorage.getItem('predicateSettings');
            if (savedPredicates) {
                predicateSettings = JSON.parse(savedPredicates);
                updatePredicateInputs();
            }

            const savedCredentials = localStorage.getItem('authCredentials');
            if (savedCredentials) {
                AUTH_CREDENTIALS = JSON.parse(savedCredentials);
            }

            const savedWebsiteSettings = localStorage.getItem('websiteSettings');
            if (savedWebsiteSettings) {
                websiteSettings = JSON.parse(savedWebsiteSettings);
                updateWebsiteNameDisplay();
            }


        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('classesData', JSON.stringify(classesData));
            localStorage.setItem('studentsData', JSON.stringify(studentsData));
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('attendanceHistoryData', JSON.stringify(attendanceHistoryData));
            localStorage.setItem('journalData', JSON.stringify(journalData));
            localStorage.setItem('assessmentData', JSON.stringify(assessmentData));
            localStorage.setItem('gradesData', JSON.stringify(gradesData));
            localStorage.setItem('weightSettings', JSON.stringify(weightSettings));
            localStorage.setItem('predicateSettings', JSON.stringify(predicateSettings));
            localStorage.setItem('authCredentials', JSON.stringify(AUTH_CREDENTIALS));
            localStorage.setItem('websiteSettings', JSON.stringify(websiteSettings));

        }

        // Navigation functions
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all sidebar items
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to clicked sidebar item
            event.target.classList.add('active');

            // Update dashboard when showing dashboard
            if (sectionId === 'dashboard') {
                updateDashboard();
            }
        }

        // Update dashboard statistics
        function updateDashboard() {
            document.getElementById('totalKelas').textContent = classesData.length;
            document.getElementById('totalSiswa').textContent = studentsData.length;
            
            // Count today's attendance
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceData.filter(att => att.date === today);
            document.getElementById('presensiHariIni').textContent = todayAttendance.length;
            
            // Count today's journal entries
            const todayJournal = journalData.filter(journal => journal.date === today);
            document.getElementById('jurnalHariIni').textContent = todayJournal.length;
            
            // Update charts and lists
            updateGenderChart();
            updateTopGradesClassFilter();
            updateTopGradesList();
        }

        // Gender distribution chart
        function updateGenderChart() {
            const canvas = document.getElementById('genderChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            if (classesData.length === 0) {
                // Show "No data" message
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Belum ada data kelas', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Prepare data
            const genderData = [];
            classesData.forEach(classItem => {
                const classStudents = studentsData.filter(s => s.class === classItem.name);
                const maleCount = classStudents.filter(s => s.gender === 'L').length;
                const femaleCount = classStudents.filter(s => s.gender === 'P').length;
                
                genderData.push({
                    className: classItem.name,
                    male: maleCount,
                    female: femaleCount,
                    total: maleCount + femaleCount
                });
            });
            
            if (genderData.every(d => d.total === 0)) {
                // Show "No students" message
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Belum ada data siswa', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Chart dimensions
            const padding = 60;
            const chartWidth = canvas.width - (padding * 2);
            const chartHeight = canvas.height - (padding * 2);
            const barWidth = Math.max(30, chartWidth / (genderData.length * 2.5));
            const maxValue = Math.max(...genderData.map(d => Math.max(d.male, d.female))) || 1;
            
            // Draw bars
            genderData.forEach((data, index) => {
                const x = padding + (index * barWidth * 2.5);
                
                // Male bar
                const maleHeight = (data.male / maxValue) * chartHeight;
                ctx.fillStyle = '#3B82F6'; // Blue
                ctx.fillRect(x, padding + chartHeight - maleHeight, barWidth * 0.8, maleHeight);
                
                // Female bar
                const femaleHeight = (data.female / maxValue) * chartHeight;
                ctx.fillStyle = '#EC4899'; // Pink
                ctx.fillRect(x + barWidth, padding + chartHeight - femaleHeight, barWidth * 0.8, femaleHeight);
                
                // Class name
                ctx.fillStyle = '#374151';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(data.className, x + barWidth, canvas.height - 20);
                
                // Values on bars
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 10px Arial';
                if (maleHeight > 20) {
                    ctx.fillText(data.male.toString(), x + barWidth * 0.4, padding + chartHeight - maleHeight + 15);
                }
                if (femaleHeight > 20) {
                    ctx.fillText(data.female.toString(), x + barWidth * 1.4, padding + chartHeight - femaleHeight + 15);
                }
            });
            
            // Y-axis labels
            ctx.fillStyle = '#6B7280';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = Math.round((maxValue / 5) * i);
                const y = padding + chartHeight - (i * chartHeight / 5);
                ctx.fillText(value.toString(), padding - 10, y + 4);
                
                // Grid lines
                ctx.strokeStyle = '#E5E7EB';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
        }

        // Top grades class filter
        function updateTopGradesClassFilter() {
            const filterSelect = document.getElementById('topGradesClassFilter');
            if (!filterSelect) return;
            
            const currentValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">Pilih Kelas</option>';
            
            classesData.forEach(classData => {
                const option = document.createElement('option');
                option.value = classData.name;
                option.textContent = classData.name;
                filterSelect.appendChild(option);
            });
            
            if (currentValue) filterSelect.value = currentValue;
        }

        // Top grades list
        function updateTopGradesList() {
            const listContainer = document.getElementById('topGradesList');
            const selectedClass = document.getElementById('topGradesClassFilter').value;
            
            if (!listContainer) return;
            
            if (!selectedClass) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        Pilih kelas untuk melihat 3 nilai tertinggi
                    </div>
                `;
                return;
            }
            
            // Get students from selected class
            const classStudents = studentsData.filter(s => s.class === selectedClass);
            
            if (classStudents.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        Tidak ada siswa di kelas ${selectedClass}
                    </div>
                `;
                return;
            }
            
            // Calculate average grades and attendance for each student
            const studentGrades = [];
            classStudents.forEach(student => {
                const studentGradeRecords = gradesData.filter(g => g.studentId === student.id);
                
                // Calculate attendance count for this student in selected class
                const studentAttendance = attendanceData.filter(att => 
                    att.studentId === student.id && 
                    att.class === selectedClass && 
                    att.status === 'hadir'
                );
                const attendanceCount = studentAttendance.length;
                
                if (studentGradeRecords.length > 0) {
                    const totalScore = studentGradeRecords.reduce((sum, grade) => sum + grade.score, 0);
                    const averageScore = totalScore / studentGradeRecords.length;
                    studentGrades.push({
                        studentName: student.name,
                        studentNIS: student.nis,
                        score: averageScore,
                        totalAssessments: studentGradeRecords.length,
                        attendanceCount: attendanceCount
                    });
                }
            });
            
            if (studentGrades.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        Belum ada data nilai untuk kelas ${selectedClass}
                    </div>
                `;
                return;
            }
            
            // Sort by score (highest first), then by attendance count (highest first) as tiebreaker
            studentGrades.sort((a, b) => {
                // Primary sort: by score (highest first)
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                // Secondary sort: by attendance count (highest first) when scores are equal
                return b.attendanceCount - a.attendanceCount;
            });
            const top3Students = studentGrades.slice(0, 3);
            
            // Generate list HTML
            let listHTML = '';
            const rankIcons = ['ü•á', 'ü•à', 'ü•â'];
            const rankColors = ['text-yellow-600 bg-yellow-50', 'text-gray-600 bg-gray-50', 'text-orange-600 bg-orange-50'];
            const rankLabels = ['Peringkat 1', 'Peringkat 2', 'Peringkat 3'];
            
            top3Students.forEach((student, index) => {
                const rankIcon = rankIcons[index];
                const rankColor = rankColors[index];
                const rankLabel = rankLabels[index];
                
                listHTML += `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="text-3xl">${rankIcon}</div>
                            <div>
                                <div class="font-semibold text-lg text-gray-800">${student.studentName}</div>
                                <div class="text-sm text-gray-600">NISN: ${student.studentNIS}</div>
                                <div class="flex gap-3 text-xs text-gray-500 mt-1">
                                    <span>üìä ${student.totalAssessments} penilaian</span>
                                    <span>‚úÖ ${student.attendanceCount} kehadiran</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-600">${student.score.toFixed(1)}</div>
                            <div class="text-sm ${rankColor} px-2 py-1 rounded-full font-medium">${rankLabel}</div>
                        </div>
                    </div>
                `;
            });
            
            // Add summary if there are more students
            if (studentGrades.length > 3) {
                listHTML += `
                    <div class="text-center text-sm text-gray-500 py-3 border-t border-gray-200">
                        Menampilkan 3 teratas dari ${studentGrades.length} siswa yang memiliki nilai
                    </div>
                `;
            }
            
            listContainer.innerHTML = listHTML;
        }

        // Class management functions
        function showAddClassForm() {
            document.getElementById('addClassForm').classList.remove('hidden');
        }

        function hideAddClassForm() {
            document.getElementById('addClassForm').classList.add('hidden');
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassDescription').value = '';
        }

        function addClass(event) {
            event.preventDefault();
            
            const className = document.getElementById('newClassName').value;
            const classDescription = document.getElementById('newClassDescription').value;
            
            if (className) {
                const newClass = {
                    id: Date.now(),
                    name: className,
                    description: classDescription,
                    studentCount: 0
                };
                
                classesData.push(newClass);
                updateClassViews();
                updateAllClassOptions();
                hideAddClassForm();
                saveData();
                updateDashboard();
            }
        }

        function updateClassViews() {
            updateThumbnailView();
            updateListView();
        }

        function updateThumbnailView() {
            const container = document.getElementById('thumbnailView');
            container.innerHTML = '';
            
            classesData.forEach((classData, index) => {
                const classCard = document.createElement('div');
                classCard.className = 'class-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all';
                classCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">${classData.name}</h3>
                        <div class="flex gap-1 flex-wrap">
                            <button onclick="editClassFull(${classData.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-sm bg-blue-50 hover:bg-blue-100 transition-colors">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="moveClassUp(${classData.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm bg-green-50 hover:bg-green-100 transition-colors ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>
                                ‚¨ÜÔ∏è Up
                            </button>
                            <button onclick="moveClassDown(${classData.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm bg-green-50 hover:bg-green-100 transition-colors ${index === classesData.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === classesData.length - 1 ? 'disabled' : ''}>
                                ‚¨áÔ∏è Down
                            </button>
                            <button onclick="deleteClass(${classData.id})" class="text-red-600 hover:text-red-800 px-2 py-1 rounded text-sm bg-red-50 hover:bg-red-100 transition-colors">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-600 mb-4">${classData.description || 'Tidak ada deskripsi'}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">üë• ${classData.studentCount} siswa</span>
                        <button onclick="viewClassDetails(${classData.id})" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm">
                            Lihat Detail
                        </button>
                    </div>
                `;
                container.appendChild(classCard);
            });
        }

        function updateListView() {
            const tbody = document.getElementById('classListBody');
            tbody.innerHTML = '';
            
            classesData.forEach((classData, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">${classData.name}</td>
                    <td class="py-3 px-4 text-gray-600">${classData.description || 'Tidak ada deskripsi'}</td>
                    <td class="py-3 px-4">${classData.studentCount} siswa</td>
                    <td class="py-3 px-4">
                        <div class="flex gap-1 flex-wrap">
                            <button onclick="editClassFull(${classData.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-sm bg-blue-50 hover:bg-blue-100 transition-colors">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="moveClassUp(${classData.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm bg-green-50 hover:bg-green-100 transition-colors ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>
                                ‚¨ÜÔ∏è Up
                            </button>
                            <button onclick="moveClassDown(${classData.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm bg-green-50 hover:bg-green-100 transition-colors ${index === classesData.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === classesData.length - 1 ? 'disabled' : ''}>
                                ‚¨áÔ∏è Down
                            </button>
                            <button onclick="deleteClass(${classData.id})" class="text-red-600 hover:text-red-800 px-2 py-1 rounded text-sm bg-red-50 hover:bg-red-100 transition-colors">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleView(viewType) {
            const thumbnailView = document.getElementById('thumbnailView');
            const listView = document.getElementById('listView');
            const thumbnailBtn = document.getElementById('thumbnailBtn');
            const listBtn = document.getElementById('listBtn');

            if (viewType === 'thumbnail') {
                thumbnailView.classList.remove('hidden');
                listView.classList.add('hidden');
                thumbnailBtn.classList.add('active');
                listBtn.classList.remove('active');
            } else {
                thumbnailView.classList.add('hidden');
                listView.classList.remove('hidden');
                thumbnailBtn.classList.remove('active');
                listBtn.classList.add('active');
            }
        }

        function editClassFull(classId) {
            const classData = classesData.find(c => c.id === classId);
            if (!classData) return;
            
            // Show edit form modal
            showEditClassForm(classData);
        }

        function showEditClassForm(classData) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold">Edit Data Kelas</h3>
                    </div>
                    <div class="p-6">
                        <form id="editClassForm" class="space-y-4">
                            <div>
                                <label for="editClassName" class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                                <input type="text" id="editClassName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Contoh: X IPA 1">
                            </div>
                            <div>
                                <label for="editClassDescription" class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                                <textarea id="editClassDescription" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" rows="3" placeholder="Deskripsi kelas (opsional)"></textarea>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <strong>üìä Info:</strong> Kelas ini memiliki ${classData.studentCount} siswa terdaftar.
                                </p>
                            </div>
                            <div class="flex gap-4 pt-4">
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    üíæ Simpan Perubahan
                                </button>
                                <button type="button" onclick="closeEditClassModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    ‚ùå Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Fill form with current class data
            document.getElementById('editClassName').value = classData.name;
            document.getElementById('editClassDescription').value = classData.description || '';
            
            // Handle form submission
            document.getElementById('editClassForm').onsubmit = function(event) {
                event.preventDefault();
                
                const newName = document.getElementById('editClassName').value.trim();
                const newDescription = document.getElementById('editClassDescription').value.trim();
                
                if (!newName) {
                    alert('Nama kelas tidak boleh kosong!');
                    return;
                }
                
                // Check if class name already exists (exclude current class)
                const existingClass = classesData.find(c => c.name === newName && c.id !== classData.id);
                if (existingClass) {
                    alert('Nama kelas sudah digunakan!');
                    return;
                }
                
                // Update class data
                const oldName = classData.name;
                classData.name = newName;
                classData.description = newDescription;
                
                // Update student records if class name changed
                if (oldName !== newName) {
                    studentsData.forEach(student => {
                        if (student.class === oldName) {
                            student.class = newName;
                        }
                    });
                    
                    // Update attendance records
                    attendanceData.forEach(attendance => {
                        if (attendance.class === oldName) {
                            attendance.class = newName;
                        }
                    });
                    
                    // Update journal records
                    journalData.forEach(journal => {
                        if (journal.class === oldName) {
                            journal.class = newName;
                        }
                    });
                    
                    // Update assessment records
                    assessmentData.forEach(assessment => {
                        if (assessment.class === oldName) {
                            assessment.class = newName;
                        }
                    });
                }
                
                updateClassViews();
                updateAllClassOptions();
                updateStudentsList();
                saveData();
                closeEditClassModal();
                alert('Data kelas berhasil diperbarui!');
            };
            
            // Close modal when clicking overlay
            modalOverlay.onclick = function(event) {
                if (event.target === modalOverlay) {
                    closeEditClassModal();
                }
            };
        }

        function closeEditClassModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        function moveClassUp(classId) {
            const currentIndex = classesData.findIndex(c => c.id === classId);
            if (currentIndex > 0) {
                // Swap with previous class
                [classesData[currentIndex], classesData[currentIndex - 1]] = 
                [classesData[currentIndex - 1], classesData[currentIndex]];
                
                updateClassViews();
                saveData();
            }
        }

        function moveClassDown(classId) {
            const currentIndex = classesData.findIndex(c => c.id === classId);
            if (currentIndex < classesData.length - 1) {
                // Swap with next class
                [classesData[currentIndex], classesData[currentIndex + 1]] = 
                [classesData[currentIndex + 1], classesData[currentIndex]];
                
                updateClassViews();
                saveData();
            }
        }

        function deleteClass(classId) {
            const classData = classesData.find(c => c.id === classId);
            if (!classData) return;
            
            // Count related data
            const relatedStudents = studentsData.filter(s => s.class === classData.name);
            const relatedAttendance = attendanceData.filter(a => a.class === classData.name);
            const relatedJournals = journalData.filter(j => j.class === classData.name);
            const relatedAssessments = assessmentData.filter(a => a.class === classData.name);
            
            let confirmMessage = `Apakah Anda yakin ingin menghapus kelas ini?\n\n`;
            confirmMessage += `Nama Kelas: ${classData.name}\n`;
            confirmMessage += `Deskripsi: ${classData.description || 'Tidak ada deskripsi'}\n`;
            confirmMessage += `Jumlah Siswa: ${relatedStudents.length}\n\n`;
            
            if (relatedStudents.length > 0 || relatedAttendance.length > 0 || relatedJournals.length > 0 || relatedAssessments.length > 0) {
                confirmMessage += `‚ö†Ô∏è PERINGATAN: Menghapus kelas ini akan juga menghapus:\n`;
                if (relatedStudents.length > 0) confirmMessage += `‚Ä¢ ${relatedStudents.length} data siswa\n`;
                if (relatedAttendance.length > 0) confirmMessage += `‚Ä¢ ${relatedAttendance.length} data presensi\n`;
                if (relatedJournals.length > 0) confirmMessage += `‚Ä¢ ${relatedJournals.length} data jurnal\n`;
                if (relatedAssessments.length > 0) confirmMessage += `‚Ä¢ ${relatedAssessments.length} data penilaian\n`;
                confirmMessage += `\nTindakan ini tidak dapat dibatalkan!`;
            }
            
            const confirmDelete = confirm(confirmMessage);
            
            if (!confirmDelete) return;
            
            // Double confirmation for classes with data
            if (relatedStudents.length > 0 || relatedAttendance.length > 0 || relatedJournals.length > 0 || relatedAssessments.length > 0) {
                const doubleConfirm = confirm(`Konfirmasi sekali lagi: Hapus kelas "${classData.name}" beserta SEMUA data terkait?`);
                if (!doubleConfirm) return;
            }
            
            // Remove class and all related data
            classesData = classesData.filter(c => c.id !== classId);
            
            // Remove related students
            const removedStudentIds = relatedStudents.map(s => s.id);
            studentsData = studentsData.filter(s => s.class !== classData.name);
            
            // Remove related attendance
            attendanceData = attendanceData.filter(a => a.class !== classData.name);
            
            // Remove related journals
            journalData = journalData.filter(j => j.class !== classData.name);
            
            // Remove related assessments and grades
            const removedAssessmentIds = relatedAssessments.map(a => a.id);
            assessmentData = assessmentData.filter(a => a.class !== classData.name);
            gradesData = gradesData.filter(g => !removedAssessmentIds.includes(g.assessmentId));
            
            updateClassViews();
            updateAllClassOptions();
            updateStudentsList();
            updateJournalList();
            updateAssessmentList();
            saveData();
            updateDashboard();
            
            alert(`Kelas "${classData.name}" berhasil dihapus beserta semua data terkait.`);
        }

        function viewClassDetails(classId) {
            const classData = classesData.find(c => c.id === classId);
            if (classData) {
                alert(`Detail Kelas: ${classData.name}\nDeskripsi: ${classData.description || 'Tidak ada deskripsi'}\nJumlah Siswa: ${classData.studentCount}`);
            }
        }

        function updateAllClassOptions() {
            // Update dropdown di menu Siswa
            const studentClassSelect = document.getElementById('studentClass');
            if (studentClassSelect) {
                const currentValue = studentClassSelect.value;
                studentClassSelect.innerHTML = '<option value="">Pilih Kelas</option>';
                classesData.forEach(classData => {
                    const option = document.createElement('option');
                    option.value = classData.name;
                    option.textContent = classData.name;
                    studentClassSelect.appendChild(option);
                });
                if (currentValue) studentClassSelect.value = currentValue;
            }

            // Update filter dropdown di menu Siswa
            const filterStudentClassSelect = document.getElementById('filterStudentClass');
            if (filterStudentClassSelect) {
                const currentValue = filterStudentClassSelect.value;
                filterStudentClassSelect.innerHTML = '<option value="">Semua Kelas</option>';
                classesData.forEach(classData => {
                    const option = document.createElement('option');
                    option.value = classData.name;
                    option.textContent = classData.name;
                    filterStudentClassSelect.appendChild(option);
                });
                if (currentValue) filterStudentClassSelect.value = currentValue;
            }

            // Update dropdown di menu Input Presensi
            const attendanceClassSelect = document.getElementById('attendanceClass');
            if (attendanceClassSelect) {
                const currentValue = attendanceClassSelect.value;
                attendanceClassSelect.innerHTML = '<option value="">Pilih Kelas</option>';
                classesData.forEach(classData => {
                    const option = document.createElement('option');
                    option.value = classData.name;
                    option.textContent = classData.name;
                    attendanceClassSelect.appendChild(option);
                });
                if (currentValue) attendanceClassSelect.value = currentValue;
            }

            // Update dropdown di menu Rekap Presensi
            const rekapClassSelect = document.getElementById('rekapClass');
            if (rekapClassSelect) {
                const currentValue = rekapClassSelect.value;
                rekapClassSelect.innerHTML = '<option value="">Pilih Kelas</option>';
                classesData.forEach(classData => {
                    const option = document.createElement('option');
                    option.value = classData.name;
                    option.textContent = classData.name;
                    rekapClassSelect.appendChild(option);
                });
                if (currentValue) rekapClassSelect.value = currentValue;
            }

            // Update dropdown di menu Jurnal
            const jurnalClassSelect = document.getElementById('jurnalClass');
            if (jurnalClassSelect) {
                const currentValue = jurnalClassSelect.value;
                jurnalClassSelect.innerHTML = '<option value="">Pilih Kelas</option>';
                classesData.forEach(classData => {
                    const option = document.createElement('option');
                    option.value = classData.name;
                    option.textContent = classData.name;
                    jurnalClassSelect.appendChild(option);
                });
                if (currentValue) jurnalClassSelect.value = currentValue;
            }

            // Update dropdown di menu Input Nilai
            const nilaiClassSelect = document.getElementById('nilaiClass');
            if (nilaiClassSelect) {
                const currentValue = nilaiClassSelect.value;
                nilaiClassSelect.innerHTML = '<option value="">Pilih Kelas</option>';
                classesData.forEach(classData => {
                    const option = document.createElement('option');
                    option.value = classData.name;
                    option.textContent = classData.name;
                    nilaiClassSelect.appendChild(option);
                });
                if (currentValue) nilaiClassSelect.value = currentValue;
            }

            // Update dropdown di menu Rekap Nilai
            const rekapNilaiClassSelect = document.getElementById('rekapNilaiClass');
            if (rekapNilaiClassSelect) {
                const currentValue = rekapNilaiClassSelect.value;
                rekapNilaiClassSelect.innerHTML = '<option value="">Pilih Kelas</option>';
                classesData.forEach(classData => {
                    const option = document.createElement('option');
                    option.value = classData.name;
                    option.textContent = classData.name;
                    rekapNilaiClassSelect.appendChild(option);
                });
                if (currentValue) rekapNilaiClassSelect.value = currentValue;
            }

            // Update attendance history class filter
            updateAttendanceHistoryOptions();
            
            // Update top grades class filter
            updateTopGradesClassFilter();
        }

        // Student management functions
        function addStudent(event) {
            event.preventDefault();
            
            const name = document.getElementById('studentName').value;
            const nis = document.getElementById('studentNIS').value;
            const className = document.getElementById('studentClass').value;
            const gender = document.getElementById('studentGender').value;
            
            if (name && nis && className && gender) {
                const newStudent = {
                    id: Date.now(),
                    name: name,
                    nis: nis,
                    class: className,
                    gender: gender
                };
                
                studentsData.push(newStudent);
                
                // Update class student count
                const classData = classesData.find(c => c.name === className);
                if (classData) {
                    classData.studentCount++;
                    updateClassViews();
                }
                
                updateStudentsList();
                saveData();
                updateDashboard();
                
                // Reset form
                document.getElementById('studentName').value = '';
                document.getElementById('studentNIS').value = '';
                document.getElementById('studentClass').value = '';
                document.getElementById('studentGender').value = '';
            }
        }

        function updateStudentsList() {
            const tbody = document.getElementById('studentsList');
            const filterClass = document.getElementById('filterStudentClass').value;
            const searchName = document.getElementById('searchStudentName') ? document.getElementById('searchStudentName').value.toLowerCase() : '';
            tbody.innerHTML = '';
            
            // Filter students based on selected class
            let filteredStudents = filterClass ? 
                studentsData.filter(student => student.class === filterClass) : 
                studentsData;
            
            // Filter students based on search name
            if (searchName) {
                filteredStudents = filteredStudents.filter(student => 
                    student.name.toLowerCase().includes(searchName) || 
                    student.nis.includes(searchName)
                );
            }
            
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'student-row border-b border-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">${student.nis}</td>
                    <td class="py-3 px-4">${student.name}</td>
                    <td class="py-3 px-4">${student.class}</td>
                    <td class="py-3 px-4">${student.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                    <td class="py-3 px-4">
                        <div class="flex gap-1 flex-wrap">
                            <button onclick="editStudentFull(${student.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-sm bg-blue-50 hover:bg-blue-100 transition-colors">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="moveStudentUp(${student.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm bg-green-50 hover:bg-green-100 transition-colors ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>
                                ‚¨ÜÔ∏è Up
                            </button>
                            <button onclick="moveStudentDown(${student.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm bg-green-50 hover:bg-green-100 transition-colors ${index === filteredStudents.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === filteredStudents.length - 1 ? 'disabled' : ''}>
                                ‚¨áÔ∏è Down
                            </button>
                            <button onclick="deleteStudent(${student.id})" class="text-red-600 hover:text-red-800 px-2 py-1 rounded text-sm bg-red-50 hover:bg-red-100 transition-colors">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Show message if no students found
            if (filteredStudents.length === 0) {
                const row = document.createElement('tr');
                let message = 'Belum ada data siswa';
                
                if (searchName && filterClass) {
                    message = `Tidak ada siswa dengan nama "${document.getElementById('searchStudentName').value}" di kelas ${filterClass}`;
                } else if (searchName) {
                    message = `Tidak ada siswa dengan nama "${document.getElementById('searchStudentName').value}"`;
                } else if (filterClass) {
                    message = `Tidak ada siswa di kelas ${filterClass}`;
                }
                
                row.innerHTML = `
                    <td colspan="5" class="py-8 px-4 text-center text-gray-500">
                        ${message}
                    </td>
                `;
                tbody.appendChild(row);
            }
            
            // Show/hide clear search button
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                if (searchName) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
            }
        }

        function searchStudents() {
            updateStudentsList();
        }

        function clearStudentSearch() {
            const searchInput = document.getElementById('searchStudentName');
            if (searchInput) {
                searchInput.value = '';
                updateStudentsList();
                searchInput.focus();
            }
        }

        function filterStudentsByClass() {
            updateStudentsList();
        }

        function editStudentFull(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;
            
            // Show edit form modal
            showEditStudentForm(student);
        }

        function showEditStudentForm(student) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold">Edit Data Siswa</h3>
                    </div>
                    <div class="p-6">
                        <form id="editStudentForm" class="space-y-4">
                            <div>
                                <label for="editStudentName" class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label>
                                <input type="text" id="editStudentName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nama lengkap siswa">
                            </div>
                            <div>
                                <label for="editStudentNIS" class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                                <input type="text" id="editStudentNIS" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nomor Induk Siswa Nasional">
                            </div>
                            <div>
                                <label for="editStudentClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="editStudentClass" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label for="editStudentGender" class="block text-sm font-medium text-gray-700 mb-2">Jenis Kelamin</label>
                                <select id="editStudentGender" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Jenis Kelamin</option>
                                    <option value="L">Laki-laki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>
                            <div class="flex gap-4 pt-4">
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    üíæ Simpan Perubahan
                                </button>
                                <button type="button" onclick="closeEditStudentModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    ‚ùå Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Populate class options
            const editClassSelect = document.getElementById('editStudentClass');
            classesData.forEach(classData => {
                const option = document.createElement('option');
                option.value = classData.name;
                option.textContent = classData.name;
                editClassSelect.appendChild(option);
            });
            
            // Fill form with current student data
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentNIS').value = student.nis;
            document.getElementById('editStudentClass').value = student.class;
            document.getElementById('editStudentGender').value = student.gender;
            
            // Handle form submission
            document.getElementById('editStudentForm').onsubmit = function(event) {
                event.preventDefault();
                
                const newName = document.getElementById('editStudentName').value.trim();
                const newNIS = document.getElementById('editStudentNIS').value.trim();
                const newClass = document.getElementById('editStudentClass').value;
                const newGender = document.getElementById('editStudentGender').value;
                
                // Validate NISN uniqueness (exclude current student)
                const existingStudent = studentsData.find(s => s.nis === newNIS && s.id !== student.id);
                if (existingStudent) {
                    alert('NISN sudah digunakan oleh siswa lain!');
                    return;
                }
                
                // Update class student count if class changed
                if (student.class !== newClass) {
                    // Decrease count from old class
                    const oldClassData = classesData.find(c => c.name === student.class);
                    if (oldClassData) {
                        oldClassData.studentCount--;
                    }
                    
                    // Increase count for new class
                    const newClassData = classesData.find(c => c.name === newClass);
                    if (newClassData) {
                        newClassData.studentCount++;
                    }
                    
                    updateClassViews();
                }
                
                // Update student data
                student.name = newName;
                student.nis = newNIS;
                student.class = newClass;
                student.gender = newGender;
                
                updateStudentsList();
                updateAllClassOptions();
                saveData();
                closeEditStudentModal();
                alert('Data siswa berhasil diperbarui!');
            };
            
            // Close modal when clicking overlay
            modalOverlay.onclick = function(event) {
                if (event.target === modalOverlay) {
                    closeEditStudentModal();
                }
            };
        }

        function closeEditStudentModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        function moveStudentUp(studentId) {
            const currentIndex = studentsData.findIndex(s => s.id === studentId);
            if (currentIndex > 0) {
                // Swap with previous student
                [studentsData[currentIndex], studentsData[currentIndex - 1]] = 
                [studentsData[currentIndex - 1], studentsData[currentIndex]];
                
                updateStudentsList();
                saveData();
            }
        }

        function moveStudentDown(studentId) {
            const currentIndex = studentsData.findIndex(s => s.id === studentId);
            if (currentIndex < studentsData.length - 1) {
                // Swap with next student
                [studentsData[currentIndex], studentsData[currentIndex + 1]] = 
                [studentsData[currentIndex + 1], studentsData[currentIndex]];
                
                updateStudentsList();
                saveData();
            }
        }

        function deleteStudent(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;
            
            const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus siswa ini?\n\nNama: ${student.name}\nNISN: ${student.nis}\nKelas: ${student.class}\n\nTindakan ini tidak dapat dibatalkan!`);
            
            if (confirmDelete) {
                // Update class student count
                const classData = classesData.find(c => c.name === student.class);
                if (classData) {
                    classData.studentCount--;
                    updateClassViews();
                }
                
                // Remove student from data
                studentsData = studentsData.filter(s => s.id !== studentId);
                
                // Also remove related attendance and grade data
                attendanceData = attendanceData.filter(att => att.studentId !== studentId);
                gradesData = gradesData.filter(grade => grade.studentId !== studentId);
                
                updateStudentsList();
                saveData();
                updateDashboard();
                
                alert(`Siswa ${student.name} berhasil dihapus beserta semua data terkait.`);
            }
        }

        // Attendance functions
        function loadStudentsForAttendance() {
            const selectedClass = document.getElementById('attendanceClass').value;
            const container = document.getElementById('attendanceContainer');
            const list = document.getElementById('attendanceList');
            
            if (selectedClass) {
                const classStudents = studentsData.filter(s => s.class === selectedClass);
                
                list.innerHTML = '';
                classStudents.forEach(student => {
                    const attendanceItem = document.createElement('div');
                    attendanceItem.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg';
                    attendanceItem.innerHTML = `
                        <div class="flex items-center gap-4">
                            <span class="font-medium">${student.name}</span>
                            <span class="text-sm text-gray-500">(${student.nis})</span>
                        </div>
                        <div class="flex gap-2">
                            <label class="flex items-center gap-1">
                                <input type="radio" name="attendance_${student.id}" value="hadir" class="text-green-600" checked>
                                <span class="text-sm">‚úÖ Hadir</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="radio" name="attendance_${student.id}" value="sakit" class="text-yellow-600">
                                <span class="text-sm">ü§í Sakit</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="radio" name="attendance_${student.id}" value="izin" class="text-blue-600">
                                <span class="text-sm">üìù Izin</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="radio" name="attendance_${student.id}" value="alpha" class="text-red-600">
                                <span class="text-sm">‚ùå Alpha</span>
                            </label>
                        </div>
                    `;
                    list.appendChild(attendanceItem);
                });
                
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function saveAttendance() {
            const selectedClass = document.getElementById('attendanceClass').value;
            const selectedDate = document.getElementById('attendanceDate').value;
            
            if (!selectedClass || !selectedDate) {
                alert('Pilih kelas dan tanggal terlebih dahulu!');
                return;
            }
            
            const classStudents = studentsData.filter(s => s.class === selectedClass);
            let savedCount = 0;
            let attendanceStats = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
            
            // Check if this is an edit (existing attendance for this class and date)
            const existingAttendance = attendanceData.filter(att => att.class === selectedClass && att.date === selectedDate);
            const isEdit = existingAttendance.length > 0;
            
            classStudents.forEach(student => {
                const attendanceRadios = document.getElementsByName(`attendance_${student.id}`);
                const selectedStatus = Array.from(attendanceRadios).find(radio => radio.checked);
                
                if (selectedStatus) {
                    const attendanceRecord = {
                        id: Date.now() + student.id,
                        studentId: student.id,
                        studentName: student.name,
                        class: selectedClass,
                        date: selectedDate,
                        status: selectedStatus.value
                    };
                    
                    // Remove existing attendance for same student, class, and date
                    attendanceData = attendanceData.filter(att => 
                        !(att.studentId === student.id && att.class === selectedClass && att.date === selectedDate)
                    );
                    
                    attendanceData.push(attendanceRecord);
                    attendanceStats[selectedStatus.value]++;
                    savedCount++;
                }
            });
            
            if (savedCount > 0) {
                // Create or update attendance history record
                const historyId = `${selectedClass}_${selectedDate}`;
                const existingHistoryIndex = attendanceHistoryData.findIndex(h => h.id === historyId);
                
                const historyRecord = {
                    id: historyId,
                    class: selectedClass,
                    date: selectedDate,
                    totalStudents: classStudents.length,
                    attendedStudents: savedCount,
                    stats: attendanceStats,
                    inputTime: new Date().toISOString(),
                    isEdit: isEdit
                };
                
                if (existingHistoryIndex >= 0) {
                    // Update existing history record
                    attendanceHistoryData[existingHistoryIndex] = historyRecord;
                } else {
                    // Add new history record
                    attendanceHistoryData.unshift(historyRecord); // Add to beginning for newest first
                }
                
                // Keep only last 50 history records to prevent excessive data
                if (attendanceHistoryData.length > 50) {
                    attendanceHistoryData = attendanceHistoryData.slice(0, 50);
                }
                
                saveData();
                updateDashboard();
                updateAttendanceHistory();
                
                const actionText = isEdit ? 'diperbarui' : 'disimpan';
                alert(`Presensi berhasil ${actionText} untuk ${savedCount} siswa!`);
            } else {
                alert('Tidak ada presensi yang dipilih!');
            }
        }

        // Attendance History functions with pagination
        let currentHistoryPage = 1;
        const recordsPerPage = 5;
        
        function updateAttendanceHistoryOptions() {
            const historyClassFilter = document.getElementById('historyClassFilter');
            if (historyClassFilter) {
                const currentValue = historyClassFilter.value;
                historyClassFilter.innerHTML = '<option value="">Semua Kelas</option>';
                classesData.forEach(classData => {
                    const option = document.createElement('option');
                    option.value = classData.name;
                    option.textContent = classData.name;
                    historyClassFilter.appendChild(option);
                });
                if (currentValue) historyClassFilter.value = currentValue;
            }
        }

        function updateAttendanceHistory() {
            const tbody = document.getElementById('attendanceHistoryList');
            const filterClass = document.getElementById('historyClassFilter').value;
            tbody.innerHTML = '';
            
            // Filter history based on selected class
            let filteredHistory = filterClass ? 
                attendanceHistoryData.filter(history => history.class === filterClass) : 
                attendanceHistoryData;
            
            // Sort by input time (newest first)
            filteredHistory.sort((a, b) => new Date(b.inputTime) - new Date(a.inputTime));
            
            // Calculate pagination
            const totalRecords = filteredHistory.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const startIndex = (currentHistoryPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            
            // Get records for current page
            const pageRecords = filteredHistory.slice(startIndex, endIndex);
            
            pageRecords.forEach(history => {
                const inputTime = new Date(history.inputTime);
                const formattedTime = inputTime.toLocaleString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const formattedDate = new Date(history.date).toLocaleDateString('id-ID', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                const attendancePercentage = history.totalStudents > 0 ? 
                    ((history.stats.hadir / history.totalStudents) * 100).toFixed(1) : '0.0';
                
                let percentageClass = '';
                if (attendancePercentage >= 90) {
                    percentageClass = 'text-green-600 font-semibold';
                } else if (attendancePercentage >= 80) {
                    percentageClass = 'text-yellow-600 font-semibold';
                } else {
                    percentageClass = 'text-red-600 font-semibold';
                }
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">${formattedDate}</td>
                    <td class="py-3 px-4">${history.class}</td>
                    <td class="py-3 px-4 text-center">${history.totalStudents}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-medium">
                            ${history.stats.hadir}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm font-medium">
                            ${history.stats.sakit}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">
                            ${history.stats.izin}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm font-medium">
                            ${history.stats.alpha}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">
                        ${formattedTime}
                        ${history.isEdit ? '<br><span class="text-xs text-blue-600 font-medium">‚úèÔ∏è Diedit</span>' : '<br><span class="text-xs text-green-600 font-medium">‚ûï Baru</span>'}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="text-sm ${percentageClass}" title="Persentase Kehadiran">
                            ${attendancePercentage}%
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <button onclick="editAttendanceFromHistory('${history.class}', '${history.date}')" 
                                class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-sm bg-blue-50 hover:bg-blue-100 transition-colors">
                            ‚úèÔ∏è Edit
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (pageRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="10" class="py-8 px-4 text-center text-gray-500">
                        ${filterClass ? `Belum ada riwayat presensi untuk kelas ${filterClass}` : 'Belum ada riwayat presensi'}
                    </td>
                `;
                tbody.appendChild(row);
            }
            
            // Update pagination
            updateHistoryPagination(totalPages, totalRecords);
        }
        
        function updateHistoryPagination(totalPages, totalRecords) {
            const paginationContainer = document.getElementById('historyPagination');
            if (!paginationContainer) return;
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = `
                <div class="flex items-center justify-between mt-4 px-6 py-3 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">
                        Menampilkan ${Math.min((currentHistoryPage - 1) * recordsPerPage + 1, totalRecords)} - ${Math.min(currentHistoryPage * recordsPerPage, totalRecords)} dari ${totalRecords} data
                    </div>
                    <div class="flex items-center gap-2">
            `;
            
            // Previous button
            if (currentHistoryPage > 1) {
                paginationHTML += `
                    <button onclick="changeHistoryPage(${currentHistoryPage - 1})" 
                            class="px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                        ‚Äπ Sebelumnya
                    </button>
                `;
            }
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentHistoryPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page and ellipsis
            if (startPage > 1) {
                paginationHTML += `
                    <button onclick="changeHistoryPage(1)" 
                            class="px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                        1
                    </button>
                `;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-2 text-gray-500">...</span>`;
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentHistoryPage;
                paginationHTML += `
                    <button onclick="changeHistoryPage(${i})" 
                            class="px-3 py-1 text-sm border rounded transition-colors ${
                                isActive 
                                    ? 'bg-blue-600 text-white border-blue-600' 
                                    : 'bg-white border-gray-300 hover:bg-gray-50'
                            }">
                        ${i}
                    </button>
                `;
            }
            
            // Last page and ellipsis
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-2 text-gray-500">...</span>`;
                }
                paginationHTML += `
                    <button onclick="changeHistoryPage(${totalPages})" 
                            class="px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                        ${totalPages}
                    </button>
                `;
            }
            
            // Next button
            if (currentHistoryPage < totalPages) {
                paginationHTML += `
                    <button onclick="changeHistoryPage(${currentHistoryPage + 1})" 
                            class="px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                        Selanjutnya ‚Ä∫
                    </button>
                `;
            }
            
            paginationHTML += `
                    </div>
                </div>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
        }
        
        function changeHistoryPage(page) {
            currentHistoryPage = page;
            updateAttendanceHistory();
        }

        function filterAttendanceHistory() {
            currentHistoryPage = 1; // Reset to first page when filtering
            updateAttendanceHistory();
        }

        function refreshAttendanceHistory() {
            currentHistoryPage = 1; // Reset to first page when refreshing
            updateAttendanceHistory();
        }

        function editAttendanceFromHistory(className, date) {
            // Set the class and date in the input form
            document.getElementById('attendanceClass').value = className;
            document.getElementById('attendanceDate').value = date;
            
            // Load students for attendance
            loadStudentsForAttendance();
            
            // Load existing attendance data
            const existingAttendance = attendanceData.filter(att => att.class === className && att.date === date);
            
            // Pre-fill the attendance form with existing data
            existingAttendance.forEach(attendance => {
                const radioButton = document.querySelector(`input[name="attendance_${attendance.studentId}"][value="${attendance.status}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                }
            });
            
            // Scroll to the attendance form
            document.getElementById('attendanceContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function viewAttendanceDetail(className, date) {
            const attendanceRecords = attendanceData.filter(att => att.class === className && att.date === date);
            
            if (attendanceRecords.length === 0) {
                alert('Tidak ada data presensi untuk tanggal ini!');
                return;
            }
            
            const formattedDate = new Date(date).toLocaleDateString('id-ID', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            // Group by status
            const statusGroups = {
                hadir: attendanceRecords.filter(att => att.status === 'hadir'),
                sakit: attendanceRecords.filter(att => att.status === 'sakit'),
                izin: attendanceRecords.filter(att => att.status === 'izin'),
                alpha: attendanceRecords.filter(att => att.status === 'alpha')
            };
            
            let detailMessage = `DETAIL PRESENSI\n\n`;
            detailMessage += `Kelas: ${className}\n`;
            detailMessage += `Tanggal: ${formattedDate}\n`;
            detailMessage += `Total Siswa: ${attendanceRecords.length}\n\n`;
            
            detailMessage += `‚úÖ HADIR (${statusGroups.hadir.length}):\n`;
            statusGroups.hadir.forEach(att => {
                detailMessage += `‚Ä¢ ${att.studentName}\n`;
            });
            
            if (statusGroups.sakit.length > 0) {
                detailMessage += `\nü§í SAKIT (${statusGroups.sakit.length}):\n`;
                statusGroups.sakit.forEach(att => {
                    detailMessage += `‚Ä¢ ${att.studentName}\n`;
                });
            }
            
            if (statusGroups.izin.length > 0) {
                detailMessage += `\nüìù IZIN (${statusGroups.izin.length}):\n`;
                statusGroups.izin.forEach(att => {
                    detailMessage += `‚Ä¢ ${att.studentName}\n`;
                });
            }
            
            if (statusGroups.alpha.length > 0) {
                detailMessage += `\n‚ùå ALPHA (${statusGroups.alpha.length}):\n`;
                statusGroups.alpha.forEach(att => {
                    detailMessage += `‚Ä¢ ${att.studentName}\n`;
                });
            }
            
            const attendancePercentage = ((statusGroups.hadir.length / attendanceRecords.length) * 100).toFixed(1);
            detailMessage += `\nüìä Persentase Kehadiran: ${attendancePercentage}%`;
            
            alert(detailMessage);
        }

        // Rekap functions
        function generateRekap() {
            const selectedClass = document.getElementById('rekapClass').value;
            const startDate = document.getElementById('rekapStartDate').value;
            const endDate = document.getElementById('rekapEndDate').value;
            
            if (!selectedClass) {
                alert('Pilih kelas terlebih dahulu!');
                return;
            }
            
            const classStudents = studentsData.filter(s => s.class === selectedClass);
            
            // Get all attendance for the class
            let filteredAttendance = attendanceData.filter(att => att.class === selectedClass);
            
            // Apply date filter if provided
            if (startDate || endDate) {
                filteredAttendance = filteredAttendance.filter(att => {
                    const attDate = att.date;
                    let includeRecord = true;
                    
                    if (startDate && attDate < startDate) {
                        includeRecord = false;
                    }
                    if (endDate && attDate > endDate) {
                        includeRecord = false;
                    }
                    
                    return includeRecord;
                });
            }
            
            // Get unique dates from actual attendance records
            const dates = [...new Set(filteredAttendance.map(att => att.date))].sort();
            
            if (dates.length === 0) {
                alert('Tidak ada data presensi yang ditemukan untuk kelas dan rentang tanggal yang dipilih!');
                return;
            }
            
            const rekapTable = document.getElementById('rekapTable');
            
            // Format dates for display
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                return `${day}/${month}`;
            };
            
            // Format date range for period display
            const formatDateRange = (startDate, endDate) => {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                const startFormatted = start.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                const endFormatted = end.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                return `${startFormatted} s/d ${endFormatted}`;
            };
            
            let tableHTML = `
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">Informasi Rekap</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div><strong>Kelas:</strong> ${selectedClass}</div>
                        <div><strong>Jumlah Siswa:</strong> ${classStudents.length}</div>
                        <div><strong>Jumlah Hari:</strong> ${dates.length} hari</div>
                        <div><strong>Per. Tanggal:</strong> ${formatDateRange(dates[0], dates[dates.length - 1])}</div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2 text-left sticky left-0 bg-gray-100 z-10">Nama Siswa</th>
                                <th class="border border-gray-300 px-4 py-2 text-left sticky left-0 bg-gray-100 z-10" style="left: 200px;">NISN</th>
            `;
            
            // Add date columns with formatted display
            dates.forEach(date => {
                const formattedDate = formatDate(date);
                tableHTML += `<th class="border border-gray-300 px-2 py-2 text-center min-w-[60px]" title="${date}">${formattedDate}</th>`;
            });
            
            tableHTML += `
                                <th class="border border-gray-300 px-3 py-2 text-center bg-green-50">H</th>
                                <th class="border border-gray-300 px-3 py-2 text-center bg-yellow-50">S</th>
                                <th class="border border-gray-300 px-3 py-2 text-center bg-blue-50">I</th>
                                <th class="border border-gray-300 px-3 py-2 text-center bg-red-50">A</th>
                                <th class="border border-gray-300 px-3 py-2 text-center bg-gray-50">%</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            classStudents.forEach(student => {
                const studentAttendance = filteredAttendance.filter(att => att.studentId === student.id);
                
                let hadirCount = 0, sakitCount = 0, izinCount = 0, alphaCount = 0;
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2 font-medium sticky left-0 bg-white z-10">${student.name}</td>
                        <td class="border border-gray-300 px-4 py-2 sticky left-0 bg-white z-10" style="left: 200px;">${student.nis}</td>
                `;
                
                dates.forEach(date => {
                    const attendance = studentAttendance.find(att => att.date === date);
                    const status = attendance ? attendance.status : '-';
                    let statusClass = '';
                    let statusDisplay = '';
                    
                    switch(status) {
                        case 'hadir':
                            statusClass = 'status-hadir';
                            statusDisplay = '‚úì';
                            hadirCount++;
                            break;
                        case 'sakit':
                            statusClass = 'status-sakit';
                            statusDisplay = 'S';
                            sakitCount++;
                            break;
                        case 'izin':
                            statusClass = 'status-izin';
                            statusDisplay = 'I';
                            izinCount++;
                            break;
                        case 'alpha':
                            statusClass = 'status-alpha';
                            statusDisplay = 'A';
                            alphaCount++;
                            break;
                        default:
                            statusDisplay = '-';
                    }
                    
                    tableHTML += `<td class="border border-gray-300 px-2 py-2 text-center ${statusClass}" title="${status === '-' ? 'Tidak ada data' : status}">${statusDisplay}</td>`;
                });
                
                // Calculate attendance percentage
                const totalDays = dates.length;
                const attendancePercentage = totalDays > 0 ? ((hadirCount / totalDays) * 100).toFixed(1) : '0.0';
                let percentageClass = '';
                
                if (attendancePercentage >= 90) {
                    percentageClass = 'bg-green-100 text-green-800 font-bold';
                } else if (attendancePercentage >= 80) {
                    percentageClass = 'bg-yellow-100 text-yellow-800 font-bold';
                } else {
                    percentageClass = 'bg-red-100 text-red-800 font-bold';
                }
                
                tableHTML += `
                        <td class="border border-gray-300 px-3 py-2 text-center font-medium bg-green-50">${hadirCount}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center font-medium bg-yellow-50">${sakitCount}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center font-medium bg-blue-50">${izinCount}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center font-medium bg-red-50">${alphaCount}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center ${percentageClass}">${attendancePercentage}%</td>
                    </tr>
                `;
            });
            
            // Add summary row
            let totalHadir = 0, totalSakit = 0, totalIzin = 0, totalAlpha = 0;
            
            classStudents.forEach(student => {
                const studentAttendance = filteredAttendance.filter(att => att.studentId === student.id);
                dates.forEach(date => {
                    const attendance = studentAttendance.find(att => att.date === date);
                    if (attendance) {
                        switch(attendance.status) {
                            case 'hadir': totalHadir++; break;
                            case 'sakit': totalSakit++; break;
                            case 'izin': totalIzin++; break;
                            case 'alpha': totalAlpha++; break;
                        }
                    }
                });
            });
            
            const totalRecords = totalHadir + totalSakit + totalIzin + totalAlpha;
            const overallPercentage = totalRecords > 0 ? ((totalHadir / totalRecords) * 100).toFixed(1) : '0.0';
            
            tableHTML += `
                        <tr class="bg-gray-100 font-bold">
                            <td class="border border-gray-300 px-4 py-2 sticky left-0 bg-gray-100 z-10">TOTAL</td>
                            <td class="border border-gray-300 px-4 py-2 sticky left-0 bg-gray-100 z-10" style="left: 200px;">-</td>
            `;
            
            dates.forEach(() => {
                tableHTML += `<td class="border border-gray-300 px-2 py-2"></td>`;
            });
            
            tableHTML += `
                            <td class="border border-gray-300 px-3 py-2 text-center bg-green-100">${totalHadir}</td>
                            <td class="border border-gray-300 px-3 py-2 text-center bg-yellow-100">${totalSakit}</td>
                            <td class="border border-gray-300 px-3 py-2 text-center bg-blue-100">${totalIzin}</td>
                            <td class="border border-gray-300 px-3 py-2 text-center bg-red-100">${totalAlpha}</td>
                            <td class="border border-gray-300 px-3 py-2 text-center bg-gray-200">${overallPercentage}%</td>
                        </tr>
                    </tbody>
                </table>
                </div>
            `;
            
            rekapTable.innerHTML = tableHTML;
            document.getElementById('rekapResults').classList.remove('hidden');
        }

        function exportRekap() {
            const selectedClass = document.getElementById('rekapClass').value;
            const startDate = document.getElementById('rekapStartDate').value;
            const endDate = document.getElementById('rekapEndDate').value;
            
            if (!selectedClass) {
                alert('Generate rekap presensi terlebih dahulu!');
                return;
            }
            
            const classStudents = studentsData.filter(s => s.class === selectedClass);
            
            // Get all attendance for the class
            let filteredAttendance = attendanceData.filter(att => att.class === selectedClass);
            
            // Apply date filter if provided
            if (startDate || endDate) {
                filteredAttendance = filteredAttendance.filter(att => {
                    const attDate = att.date;
                    let includeRecord = true;
                    
                    if (startDate && attDate < startDate) {
                        includeRecord = false;
                    }
                    if (endDate && attDate > endDate) {
                        includeRecord = false;
                    }
                    
                    return includeRecord;
                });
            }
            
            // Get unique dates from actual attendance records
            const dates = [...new Set(filteredAttendance.map(att => att.date))].sort();
            
            if (dates.length === 0) {
                alert('Tidak ada data presensi untuk diekspor!');
                return;
            }
            
            // Create CSV content
            let csvContent = "NISN,Nama Siswa";
            
            // Add date columns
            dates.forEach(date => {
                const formattedDate = new Date(date).toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                csvContent += `,${formattedDate}`;
            });
            
            // Add summary columns
            csvContent += ",Hadir,Sakit,Izin,Alpha,Persentase\n";
            
            // Add student data
            classStudents.forEach(student => {
                const studentAttendance = filteredAttendance.filter(att => att.studentId === student.id);
                
                let hadirCount = 0, sakitCount = 0, izinCount = 0, alphaCount = 0;
                
                csvContent += `${student.nis},${student.name}`;
                
                // Add attendance status for each date
                dates.forEach(date => {
                    const attendance = studentAttendance.find(att => att.date === date);
                    const status = attendance ? attendance.status : '-';
                    
                    let statusDisplay = '';
                    switch(status) {
                        case 'hadir':
                            statusDisplay = 'H';
                            hadirCount++;
                            break;
                        case 'sakit':
                            statusDisplay = 'S';
                            sakitCount++;
                            break;
                        case 'izin':
                            statusDisplay = 'I';
                            izinCount++;
                            break;
                        case 'alpha':
                            statusDisplay = 'A';
                            alphaCount++;
                            break;
                        default:
                            statusDisplay = '-';
                    }
                    
                    csvContent += `,${statusDisplay}`;
                });
                
                // Add summary data
                const totalDays = dates.length;
                const attendancePercentage = totalDays > 0 ? ((hadirCount / totalDays) * 100).toFixed(1) : '0.0';
                
                csvContent += `,${hadirCount},${sakitCount},${izinCount},${alphaCount},${attendancePercentage}%\n`;
            });
            
            // Create and download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Create filename with class and date range
            let filename = `rekap_presensi_${selectedClass.replace(/[^a-zA-Z0-9]/g, '_')}`;
            if (startDate && endDate) {
                filename += `_${startDate}_${endDate}`;
            } else if (dates.length > 0) {
                filename += `_${dates[0]}_${dates[dates.length - 1]}`;
            }
            filename += `_${new Date().toISOString().split('T')[0]}.csv`;
            
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('File CSV rekap presensi berhasil didownload!');
        }

        function showDeleteAttendanceOptions() {
            const selectedClass = document.getElementById('rekapClass').value;
            
            if (!selectedClass) {
                alert('Pilih kelas terlebih dahulu untuk melihat opsi hapus presensi!');
                return;
            }
            
            // Get all unique dates for the selected class
            const classAttendance = attendanceData.filter(att => att.class === selectedClass);
            const uniqueDates = [...new Set(classAttendance.map(att => att.date))].sort().reverse();
            
            if (uniqueDates.length === 0) {
                alert('Tidak ada data presensi untuk kelas ini!');
                return;
            }
            
            // Create modal for date selection
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-red-700">Hapus Presensi</h3>
                        <p class="text-sm text-gray-600 mt-1">Kelas: ${selectedClass}</p>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <p class="text-sm text-gray-700 mb-3">Pilih tanggal presensi yang ingin dihapus:</p>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${uniqueDates.map(date => {
                                    const attendanceCount = classAttendance.filter(att => att.date === date).length;
                                    const formattedDate = new Date(date).toLocaleDateString('id-ID', {
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    });
                                    return `
                                        <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                            <div>
                                                <div class="font-medium">${formattedDate}</div>
                                                <div class="text-sm text-gray-500">${attendanceCount} siswa tercatat</div>
                                            </div>
                                            <button onclick="deleteAttendanceByDate('${date}', '${selectedClass}')" 
                                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                                                üóëÔ∏è Hapus
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg mb-4">
                            <p class="text-sm text-yellow-800">
                                <strong>‚ö†Ô∏è Peringatan:</strong> Menghapus presensi tidak dapat dibatalkan. Semua data presensi untuk tanggal yang dipilih akan dihapus permanen.
                            </p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeDeleteAttendanceModal()" 
                                    class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                ‚ùå Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Close modal when clicking overlay
            modalOverlay.onclick = function(event) {
                if (event.target === modalOverlay) {
                    closeDeleteAttendanceModal();
                }
            };
        }

        function deleteAttendanceByDate(date, className) {
            const formattedDate = new Date(date).toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const attendanceToDelete = attendanceData.filter(att => att.date === date && att.class === className);
            
            if (attendanceToDelete.length === 0) {
                alert('Tidak ada data presensi untuk tanggal ini!');
                return;
            }
            
            const confirmDelete = confirm(
                `Apakah Anda yakin ingin menghapus semua presensi untuk:\n\n` +
                `Kelas: ${className}\n` +
                `Tanggal: ${formattedDate}\n` +
                `Jumlah data: ${attendanceToDelete.length} siswa\n\n` +
                `Tindakan ini tidak dapat dibatalkan!`
            );
            
            if (!confirmDelete) {
                return;
            }
            
            const doubleConfirm = confirm('Konfirmasi sekali lagi: Hapus semua presensi untuk tanggal ini?');
            
            if (!doubleConfirm) {
                return;
            }
            
            // Remove attendance data for the selected date and class
            const originalLength = attendanceData.length;
            attendanceData = attendanceData.filter(att => !(att.date === date && att.class === className));
            const deletedCount = originalLength - attendanceData.length;
            
            // Remove attendance history record for the deleted session
            const historyId = `${className}_${date}`;
            attendanceHistoryData = attendanceHistoryData.filter(h => h.id !== historyId);
            
            // Save updated data
            saveData();
            
            // Update dashboard
            updateDashboard();
            
            // Update attendance history display
            updateAttendanceHistory();
            
            // Close modal
            closeDeleteAttendanceModal();
            
            // Show success message
            alert(`Berhasil menghapus ${deletedCount} data presensi untuk tanggal ${formattedDate}!`);
            
            // Refresh rekap if it was already generated to remove deleted dates
            const rekapResults = document.getElementById('rekapResults');
            if (!rekapResults.classList.contains('hidden')) {
                // Clear the current rekap display first
                document.getElementById('rekapTable').innerHTML = '';
                rekapResults.classList.add('hidden');
                
                // Show message that rekap needs to be regenerated
                alert('Rekap presensi telah direset karena ada data yang dihapus. Silakan generate ulang rekap presensi.');
            }
        }

        function closeDeleteAttendanceModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        // Journal functions
        function addJournal(event) {
            event.preventDefault();
            
            const className = document.getElementById('jurnalClass').value;
            const date = document.getElementById('jurnalDate').value;
            const subject = document.getElementById('jurnalSubject').value;
            const material = document.getElementById('jurnalMaterial').value;
            const notes = document.getElementById('jurnalNotes').value;
            
            if (className && date && subject && material) {
                const newJournal = {
                    id: Date.now(),
                    class: className,
                    date: date,
                    subject: subject,
                    material: material,
                    notes: notes
                };
                
                journalData.push(newJournal);
                updateJournalList();
                saveData();
                updateDashboard();
                
                // Reset form
                document.getElementById('jurnalClass').value = '';
                document.getElementById('jurnalDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('jurnalSubject').value = '';
                document.getElementById('jurnalMaterial').value = '';
                document.getElementById('jurnalNotes').value = '';
                
                alert('Jurnal berhasil disimpan!');
            }
        }

        function updateJournalList() {
            const tbody = document.getElementById('journalList');
            tbody.innerHTML = '';
            
            // Get filter dates
            const startDate = document.getElementById('filterJurnalStartDate').value;
            const endDate = document.getElementById('filterJurnalEndDate').value;
            
            // Filter journals by date range
            let filteredJournals = journalData;
            if (startDate || endDate) {
                filteredJournals = journalData.filter(journal => {
                    const journalDate = journal.date;
                    let includeJournal = true;
                    
                    if (startDate && journalDate < startDate) {
                        includeJournal = false;
                    }
                    if (endDate && journalDate > endDate) {
                        includeJournal = false;
                    }
                    
                    return includeJournal;
                });
            }
            
            // Sort journals by date (newest first)
            const sortedJournals = filteredJournals.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedJournals.forEach(journal => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">${journal.date}</td>
                    <td class="py-3 px-4">${journal.class}</td>
                    <td class="py-3 px-4">${journal.subject}</td>
                    <td class="py-3 px-4">
                        <div class="max-w-xs">
                            <p class="text-sm text-gray-700 truncate" title="${journal.material}">${journal.material}</p>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="max-w-xs">
                            <p class="text-sm text-gray-600 truncate" title="${journal.notes || '-'}">${journal.notes || '-'}</p>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex gap-2">
                            <button onclick="viewJournalDetail(${journal.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm">
                                üëÅÔ∏è Lihat
                            </button>
                            <button onclick="editJournal(${journal.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-sm">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteJournal(${journal.id})" class="text-red-600 hover:text-red-800 px-2 py-1 rounded text-sm">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (sortedJournals.length === 0) {
                const row = document.createElement('tr');
                if (startDate || endDate) {
                    row.innerHTML = '<td colspan="6" class="py-8 px-4 text-center text-gray-500">Tidak ada jurnal dalam rentang tanggal yang dipilih.</td>';
                } else {
                    row.innerHTML = '<td colspan="6" class="py-8 px-4 text-center text-gray-500">Belum ada jurnal yang dibuat.</td>';
                }
                tbody.appendChild(row);
            }
        }

        function editJournal(journalId) {
            const journal = journalData.find(j => j.id === journalId);
            if (!journal) return;
            
            // Show edit form
            showEditJournalForm(journal);
        }

        function showEditJournalForm(journal) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold">Edit Jurnal Pembelajaran</h3>
                    </div>
                    <div class="p-6">
                        <form id="editJournalForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="editJurnalClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="editJurnalClass" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="editJurnalDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                    <input type="date" id="editJurnalDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="editJurnalSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <input type="text" id="editJurnalSubject" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nama mata pelajaran">
                            </div>
                            <div>
                                <label for="editJurnalMaterial" class="block text-sm font-medium text-gray-700 mb-2">Materi Pembelajaran</label>
                                <textarea id="editJurnalMaterial" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4" placeholder="Deskripsi materi yang diajarkan"></textarea>
                            </div>
                            <div>
                                <label for="editJurnalNotes" class="block text-sm font-medium text-gray-700 mb-2">Catatan Tambahan</label>
                                <textarea id="editJurnalNotes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Catatan atau kendala (opsional)"></textarea>
                            </div>
                            <div class="flex gap-4 pt-4">
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    üíæ Simpan Perubahan
                                </button>
                                <button type="button" onclick="closeEditJournalModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    ‚ùå Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Populate class options
            const editClassSelect = document.getElementById('editJurnalClass');
            classesData.forEach(classData => {
                const option = document.createElement('option');
                option.value = classData.name;
                option.textContent = classData.name;
                editClassSelect.appendChild(option);
            });
            
            // Fill form with current journal data
            document.getElementById('editJurnalClass').value = journal.class;
            document.getElementById('editJurnalDate').value = journal.date;
            document.getElementById('editJurnalSubject').value = journal.subject;
            document.getElementById('editJurnalMaterial').value = journal.material;
            document.getElementById('editJurnalNotes').value = journal.notes || '';
            
            // Handle form submission
            document.getElementById('editJournalForm').onsubmit = function(event) {
                event.preventDefault();
                
                const updatedJournal = {
                    ...journal,
                    class: document.getElementById('editJurnalClass').value,
                    date: document.getElementById('editJurnalDate').value,
                    subject: document.getElementById('editJurnalSubject').value,
                    material: document.getElementById('editJurnalMaterial').value,
                    notes: document.getElementById('editJurnalNotes').value
                };
                
                // Update journal in data array
                const journalIndex = journalData.findIndex(j => j.id === journal.id);
                if (journalIndex !== -1) {
                    journalData[journalIndex] = updatedJournal;
                    updateJournalList();
                    saveData();
                    closeEditJournalModal();
                    alert('Jurnal berhasil diperbarui!');
                }
            };
            
            // Close modal when clicking overlay
            modalOverlay.onclick = function(event) {
                if (event.target === modalOverlay) {
                    closeEditJournalModal();
                }
            };
        }

        function closeEditJournalModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        function viewJournalDetail(journalId) {
            const journal = journalData.find(j => j.id === journalId);
            if (journal) {
                const detailMessage = `
DETAIL JURNAL PEMBELAJARAN

Tanggal: ${journal.date}
Kelas: ${journal.class}
Mata Pelajaran: ${journal.subject}

MATERI PEMBELAJARAN:
${journal.material}

${journal.notes ? `CATATAN TAMBAHAN:\n${journal.notes}` : 'Tidak ada catatan tambahan'}
                `;
                alert(detailMessage);
            }
        }

        function deleteJournal(journalId) {
            const confirmDelete = confirm('Apakah Anda yakin ingin menghapus jurnal ini?');
            if (confirmDelete) {
                journalData = journalData.filter(j => j.id !== journalId);
                updateJournalList();
                saveData();
                updateDashboard();
            }
        }

        function filterJournalByDate() {
            updateJournalList();
        }

        function clearJournalFilter() {
            document.getElementById('filterJurnalStartDate').value = '';
            document.getElementById('filterJurnalEndDate').value = '';
            updateJournalList();
        }

        // Assessment functions
        function createAssessment(event) {
            event.preventDefault();
            
            const className = document.getElementById('nilaiClass').value;
            const assessmentType = document.getElementById('assessmentType').value;
            const assessmentName = document.getElementById('assessmentName').value;
            
            if (className && assessmentType && assessmentName) {
                const newAssessment = {
                    id: Date.now(),
                    class: className,
                    type: assessmentType,
                    name: assessmentName,
                    createdDate: new Date().toISOString().split('T')[0]
                };
                
                assessmentData.push(newAssessment);
                updateAssessmentList();
                saveData();
                
                // Reset form
                document.getElementById('nilaiClass').value = '';
                document.getElementById('assessmentType').value = '';
                document.getElementById('assessmentName').value = '';
                
                alert('Penilaian berhasil dibuat!');
            }
        }

        function updateAssessmentList() {
            const container = document.getElementById('assessmentList');
            container.innerHTML = '';
            
            // Use original order from assessmentData (for move up/down functionality)
            // Don't sort by date to maintain user-defined order
            assessmentData.forEach((assessment, index) => {
                const assessmentItem = document.createElement('div');
                assessmentItem.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                assessmentItem.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-lg">${assessment.name}</h4>
                            <p class="text-sm text-gray-600">${assessment.class} ‚Ä¢ ${assessment.type} ‚Ä¢ ${assessment.createdDate}</p>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="inputGrades(${assessment.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                üìù Input Nilai
                            </button>
                            <button onclick="editAssessment(${assessment.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-sm bg-blue-50 hover:bg-blue-100 transition-colors">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="moveAssessmentUp(${assessment.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm bg-green-50 hover:bg-green-100 transition-colors ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>
                                ‚¨ÜÔ∏è Up
                            </button>
                            <button onclick="moveAssessmentDown(${assessment.id})" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-sm bg-green-50 hover:bg-green-100 transition-colors ${index === assessmentData.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === assessmentData.length - 1 ? 'disabled' : ''}>
                                ‚¨áÔ∏è Down
                            </button>
                            <button onclick="deleteAssessment(${assessment.id})" class="text-red-600 hover:text-red-800 px-2 py-1 rounded text-sm bg-red-50 hover:bg-red-100 transition-colors">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2 pt-2 border-t border-gray-200">
                        <button onclick="downloadGradeTemplate(${assessment.id})" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 flex items-center gap-1">
                            üì• Download Template CSV
                        </button>
                        <button onclick="document.getElementById('gradeCSVUpload_${assessment.id}').click()" class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700 flex items-center gap-1">
                            üì§ Upload CSV Nilai
                        </button>
                        <input type="file" id="gradeCSVUpload_${assessment.id}" accept=".csv" style="display: none;" onchange="uploadGradeCSV(event, ${assessment.id})">
                    </div>
                `;
                container.appendChild(assessmentItem);
            });
            
            if (assessmentData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada penilaian yang dibuat.</p>';
            }
        }

        function inputGrades(assessmentId) {
            const assessment = assessmentData.find(a => a.id === assessmentId);
            if (!assessment) return;
            
            const classStudents = studentsData.filter(s => s.class === assessment.class);
            
            const gradeForm = document.getElementById('gradeInputForm');
            const gradeFormTitle = document.getElementById('gradeFormTitle');
            const gradeInputList = document.getElementById('gradeInputList');
            
            gradeFormTitle.textContent = `Input Nilai: ${assessment.name} (${assessment.class})`;
            gradeInputList.innerHTML = '';
            
            classStudents.forEach(student => {
                const existingGrade = gradesData.find(g => g.assessmentId === assessmentId && g.studentId === student.id);
                
                const gradeItem = document.createElement('div');
                gradeItem.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg';
                gradeItem.innerHTML = `
                    <div>
                        <span class="font-medium">${student.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${student.nis})</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" 
                               id="grade_${student.id}" 
                               min="0" 
                               max="100" 
                               value="${existingGrade ? existingGrade.score : ''}"
                               class="w-20 px-3 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="0-100">
                        <span class="text-sm text-gray-500">/ 100</span>
                    </div>
                `;
                gradeInputList.appendChild(gradeItem);
            });
            
            // Store current assessment ID for saving
            gradeForm.dataset.assessmentId = assessmentId;
            gradeForm.classList.remove('hidden');
        }

        function saveGrades() {
            const gradeForm = document.getElementById('gradeInputForm');
            const assessmentId = parseInt(gradeForm.dataset.assessmentId);
            const assessment = assessmentData.find(a => a.id === assessmentId);
            
            if (!assessment) return;
            
            const classStudents = studentsData.filter(s => s.class === assessment.class);
            let savedCount = 0;
            
            classStudents.forEach(student => {
                const gradeInput = document.getElementById(`grade_${student.id}`);
                const score = gradeInput.value;
                
                if (score !== '') {
                    // Remove existing grade for same student and assessment
                    gradesData = gradesData.filter(g => 
                        !(g.assessmentId === assessmentId && g.studentId === student.id)
                    );
                    
                    // Add new grade
                    const gradeRecord = {
                        id: Date.now() + student.id,
                        assessmentId: assessmentId,
                        studentId: student.id,
                        studentName: student.name,
                        score: parseFloat(score),
                        inputDate: new Date().toISOString().split('T')[0]
                    };
                    
                    gradesData.push(gradeRecord);
                    savedCount++;
                }
            });
            
            if (savedCount > 0) {
                saveData();
                alert(`Nilai berhasil disimpan untuk ${savedCount} siswa!`);
                hideGradeForm();
            } else {
                alert('Tidak ada nilai yang diinput!');
            }
        }

        function hideGradeForm() {
            document.getElementById('gradeInputForm').classList.add('hidden');
        }

        function editAssessment(assessmentId) {
            const assessment = assessmentData.find(a => a.id === assessmentId);
            if (assessment) {
                const newName = prompt('Edit nama penilaian:', assessment.name);
                if (newName && newName !== assessment.name) {
                    assessment.name = newName;
                    updateAssessmentList();
                    saveData();
                }
            }
        }

        function moveAssessmentUp(assessmentId) {
            const currentIndex = assessmentData.findIndex(a => a.id === assessmentId);
            if (currentIndex > 0) {
                // Swap with previous assessment
                [assessmentData[currentIndex], assessmentData[currentIndex - 1]] = 
                [assessmentData[currentIndex - 1], assessmentData[currentIndex]];
                
                updateAssessmentList();
                saveData();
            }
        }

        function moveAssessmentDown(assessmentId) {
            const currentIndex = assessmentData.findIndex(a => a.id === assessmentId);
            if (currentIndex < assessmentData.length - 1) {
                // Swap with next assessment
                [assessmentData[currentIndex], assessmentData[currentIndex + 1]] = 
                [assessmentData[currentIndex + 1], assessmentData[currentIndex]];
                
                updateAssessmentList();
                saveData();
            }
        }

        function deleteAssessment(assessmentId) {
            const confirmDelete = confirm('Apakah Anda yakin ingin menghapus penilaian ini? Semua nilai yang terkait juga akan dihapus.');
            if (confirmDelete) {
                assessmentData = assessmentData.filter(a => a.id !== assessmentId);
                gradesData = gradesData.filter(g => g.assessmentId !== assessmentId);
                updateAssessmentList();
                saveData();
            }
        }

        // Attendance CSV functions
        function downloadAttendanceCSVTemplate() {
            let csvContent = "Tanggal,Kelas,NISN,Nama,Status\n";
            csvContent += "2024-01-15,X IPA 1,12345,Contoh Nama Siswa,hadir\n";
            csvContent += "2024-01-15,X IPA 1,12346,Contoh Nama Siswa 2,sakit\n";
            csvContent += "2024-01-15,X IPA 1,12347,Contoh Nama Siswa 3,izin\n";
            csvContent += "2024-01-15,X IPA 1,12348,Contoh Nama Siswa 4,alpha\n";
            csvContent += "2024-01-16,X IPA 1,12345,Contoh Nama Siswa,hadir\n";
            csvContent += "2024-01-16,X IPA 1,12346,Contoh Nama Siswa 2,hadir\n";
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_presensi.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('Template CSV presensi berhasil didownload!\n\nFormat:\n- Tanggal: YYYY-MM-DD\n- Status: hadir, sakit, izin, alpha');
        }

        function uploadAttendanceCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length < 2) {
                    alert('File CSV kosong atau tidak valid!');
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Validate headers
                const expectedHeaders = ['Tanggal', 'Kelas', 'NISN', 'Nama', 'Status'];
                const isValidFormat = expectedHeaders.every(header => 
                    headers.some(h => h.toLowerCase() === header.toLowerCase())
                );
                
                if (!isValidFormat) {
                    alert('Format CSV tidak sesuai!\n\nPastikan header: Tanggal,Kelas,NISN,Nama,Status\n\nDownload template untuk format yang benar.');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                let updateCount = 0;
                const errors = [];
                const processedSessions = new Set();
                
                // Process each line
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    
                    if (values.length < 5) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Data tidak lengkap`);
                        continue;
                    }
                    
                    const [tanggal, kelas, nisn, nama, status] = values;
                    
                    // Validate data
                    if (!tanggal || !kelas || !nisn || !nama || !status) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Ada field yang kosong`);
                        continue;
                    }
                    
                    // Validate date format
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (!dateRegex.test(tanggal)) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Format tanggal harus YYYY-MM-DD`);
                        continue;
                    }
                    
                    // Validate status
                    const validStatuses = ['hadir', 'sakit', 'izin', 'alpha'];
                    if (!validStatuses.includes(status.toLowerCase())) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Status harus: hadir, sakit, izin, atau alpha`);
                        continue;
                    }
                    
                    // Find student by NISN and class
                    const student = studentsData.find(s => s.nis === nisn && s.class === kelas);
                    if (!student) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: NISN ${nisn} tidak ditemukan di kelas ${kelas}`);
                        continue;
                    }
                    
                    // Check if attendance already exists
                    const existingAttendance = attendanceData.find(att => 
                        att.studentId === student.id && att.date === tanggal && att.class === kelas
                    );
                    
                    if (existingAttendance) {
                        // Update existing attendance
                        existingAttendance.status = status.toLowerCase();
                        updateCount++;
                    } else {
                        // Add new attendance
                        const attendanceRecord = {
                            id: Date.now() + student.id + i,
                            studentId: student.id,
                            studentName: student.name,
                            class: kelas,
                            date: tanggal,
                            status: status.toLowerCase()
                        };
                        
                        attendanceData.push(attendanceRecord);
                        successCount++;
                    }
                    
                    // Track processed sessions for history update
                    processedSessions.add(`${kelas}_${tanggal}`);
                }
                
                // Update attendance history for processed sessions
                processedSessions.forEach(sessionId => {
                    const [sessionClass, sessionDate] = sessionId.split('_');
                    const sessionAttendance = attendanceData.filter(att => 
                        att.class === sessionClass && att.date === sessionDate
                    );
                    
                    if (sessionAttendance.length > 0) {
                        // Calculate stats
                        const stats = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
                        sessionAttendance.forEach(att => {
                            stats[att.status]++;
                        });
                        
                        // Find or create history record
                        const existingHistoryIndex = attendanceHistoryData.findIndex(h => h.id === sessionId);
                        const historyRecord = {
                            id: sessionId,
                            class: sessionClass,
                            date: sessionDate,
                            totalStudents: sessionAttendance.length,
                            attendedStudents: sessionAttendance.length,
                            stats: stats,
                            inputTime: new Date().toISOString(),
                            isEdit: existingHistoryIndex >= 0
                        };
                        
                        if (existingHistoryIndex >= 0) {
                            attendanceHistoryData[existingHistoryIndex] = historyRecord;
                        } else {
                            attendanceHistoryData.unshift(historyRecord);
                        }
                    }
                });
                
                // Keep only last 50 history records
                if (attendanceHistoryData.length > 50) {
                    attendanceHistoryData = attendanceHistoryData.slice(0, 50);
                }
                
                // Save data
                saveData();
                updateDashboard();
                updateAttendanceHistory();
                
                // Show results
                let message = `Upload presensi selesai!\n`;
                message += `‚úÖ Berhasil ditambah: ${successCount} presensi\n`;
                if (updateCount > 0) {
                    message += `üîÑ Berhasil diperbarui: ${updateCount} presensi\n`;
                }
                if (errorCount > 0) {
                    message += `‚ùå Error: ${errorCount} baris`;
                    if (errors.length > 0) {
                        message += '\n\nDetail error:\n' + errors.slice(0, 5).join('\n');
                        if (errors.length > 5) {
                            message += `\n... dan ${errors.length - 5} error lainnya`;
                        }
                    }
                }
                
                alert(message);
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Student CSV functions
        function downloadStudentCSVTemplate() {
            let csvContent = "NISN,Nama,Kelas,JK\n";
            csvContent += "12345,Contoh Nama Siswa,X IPA 1,L\n";
            csvContent += "12346,Contoh Nama Siswa 2,X IPA 1,P\n";
            csvContent += "12347,Contoh Nama Siswa 3,X IPS 1,L\n";
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_siswa.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function uploadStudentCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length < 2) {
                    alert('File CSV kosong atau tidak valid!');
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Validate headers
                const expectedHeaders = ['NISN', 'Nama', 'Kelas', 'JK'];
                const isValidFormat = expectedHeaders.every(header => 
                    headers.some(h => h.toLowerCase() === header.toLowerCase())
                );
                
                if (!isValidFormat) {
                    alert('Format CSV tidak sesuai! Pastikan header: NISN,Nama,Kelas,JK');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Process each line
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    
                    if (values.length < 4) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Data tidak lengkap`);
                        continue;
                    }
                    
                    const [nisn, nama, kelas, jk] = values;
                    
                    // Validate data
                    if (!nisn || !nama || !kelas || !jk) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Ada field yang kosong`);
                        continue;
                    }
                    
                    if (!['L', 'P', 'l', 'p'].includes(jk)) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Jenis kelamin harus L atau P`);
                        continue;
                    }
                    
                    // Check if NISN already exists
                    if (studentsData.some(s => s.nis === nisn)) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: NISN ${nisn} sudah ada`);
                        continue;
                    }
                    
                    // Add student
                    const newStudent = {
                        id: Date.now() + i,
                        name: nama,
                        nis: nisn,
                        class: kelas,
                        gender: jk.toUpperCase()
                    };
                    
                    studentsData.push(newStudent);
                    
                    // Update class student count
                    let classData = classesData.find(c => c.name === kelas);
                    if (!classData) {
                        // Create class if it doesn't exist
                        classData = {
                            id: Date.now() + i * 1000,
                            name: kelas,
                            description: `Kelas ${kelas} (dibuat otomatis)`,
                            studentCount: 0
                        };
                        classesData.push(classData);
                    }
                    classData.studentCount++;
                    
                    successCount++;
                }
                
                // Update displays
                updateStudentsList();
                updateClassViews();
                updateAllClassOptions();
                saveData();
                updateDashboard();
                
                // Show results
                let message = `Import selesai!\n‚úÖ Berhasil: ${successCount} siswa`;
                if (errorCount > 0) {
                    message += `\n‚ùå Error: ${errorCount} baris`;
                    if (errors.length > 0) {
                        message += '\n\nDetail error:\n' + errors.slice(0, 5).join('\n');
                        if (errors.length > 5) {
                            message += `\n... dan ${errors.length - 5} error lainnya`;
                        }
                    }
                }
                
                alert(message);
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function downloadStudentsByClass() {
            const selectedClass = document.getElementById('filterStudentClass').value;
            
            // Determine which students to download
            let studentsToDownload;
            let filename;
            
            if (selectedClass) {
                // Download students from selected class only
                studentsToDownload = studentsData.filter(s => s.class === selectedClass);
                filename = `daftar_siswa_${selectedClass.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                
                if (studentsToDownload.length === 0) {
                    alert(`Tidak ada siswa di kelas ${selectedClass}!`);
                    return;
                }
            } else {
                // Download all students
                studentsToDownload = studentsData;
                filename = `daftar_siswa_semua_kelas_${new Date().toISOString().split('T')[0]}.csv`;
                
                if (studentsToDownload.length === 0) {
                    alert('Tidak ada data siswa untuk diunduh!');
                    return;
                }
            }
            
            // Create CSV content
            let csvContent = "NISN,Nama,Kelas,JK\n";
            
            studentsToDownload.forEach(student => {
                const jk = student.gender === 'L' ? 'L' : 'P';
                csvContent += `${student.nis},${student.name},${student.class},${jk}\n`;
            });
            
            // Create and download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            
            // Show success message
            const classInfo = selectedClass ? `kelas ${selectedClass}` : 'semua kelas';
            alert(`File CSV daftar siswa ${classInfo} berhasil diunduh!\n\nJumlah siswa: ${studentsToDownload.length}`);
        }

        function deleteStudentsByClass() {
            const selectedClass = document.getElementById('filterStudentClass').value;
            
            if (!selectedClass) {
                alert('Pilih kelas terlebih dahulu untuk menghapus siswa!');
                return;
            }
            
            // Find students in the selected class
            const studentsToDelete = studentsData.filter(s => s.class === selectedClass);
            
            if (studentsToDelete.length === 0) {
                alert(`Tidak ada siswa di kelas ${selectedClass}!`);
                return;
            }
            
            // Count related data that will be deleted
            const studentIds = studentsToDelete.map(s => s.id);
            const relatedAttendance = attendanceData.filter(att => studentIds.includes(att.studentId));
            const relatedGrades = gradesData.filter(grade => studentIds.includes(grade.studentId));
            
            // Create confirmation message
            let confirmMessage = `Apakah Anda yakin ingin menghapus SEMUA siswa dari kelas ${selectedClass}?\n\n`;
            confirmMessage += `üìä Data yang akan dihapus:\n`;
            confirmMessage += `‚Ä¢ ${studentsToDelete.length} siswa\n`;
            if (relatedAttendance.length > 0) {
                confirmMessage += `‚Ä¢ ${relatedAttendance.length} data presensi\n`;
            }
            if (relatedGrades.length > 0) {
                confirmMessage += `‚Ä¢ ${relatedGrades.length} data nilai\n`;
            }
            confirmMessage += `\n‚ö†Ô∏è PERINGATAN: Tindakan ini tidak dapat dibatalkan!`;
            
            const confirmDelete = confirm(confirmMessage);
            
            if (!confirmDelete) {
                return;
            }
            
            // Double confirmation for safety
            const doubleConfirm = confirm(`Konfirmasi sekali lagi: Hapus SEMUA ${studentsToDelete.length} siswa dari kelas ${selectedClass}?`);
            
            if (!doubleConfirm) {
                return;
            }
            
            // Remove students and related data
            const originalStudentCount = studentsData.length;
            const originalAttendanceCount = attendanceData.length;
            const originalGradeCount = gradesData.length;
            
            // Remove students
            studentsData = studentsData.filter(s => s.class !== selectedClass);
            
            // Remove related attendance data
            attendanceData = attendanceData.filter(att => !studentIds.includes(att.studentId));
            
            // Remove related grade data
            gradesData = gradesData.filter(grade => !studentIds.includes(grade.studentId));
            
            // Update class student count
            const classData = classesData.find(c => c.name === selectedClass);
            if (classData) {
                classData.studentCount = 0;
                updateClassViews();
            }
            
            // Update attendance history - remove sessions that now have no students
            attendanceHistoryData = attendanceHistoryData.filter(history => {
                if (history.class === selectedClass) {
                    // Check if there are still attendance records for this class and date
                    const remainingAttendance = attendanceData.filter(att => 
                        att.class === selectedClass && att.date === history.date
                    );
                    return remainingAttendance.length > 0;
                }
                return true;
            });
            
            // Save updated data
            saveData();
            
            // Update all displays
            updateStudentsList();
            updateDashboard();
            updateAttendanceHistory();
            
            // Calculate deleted counts
            const deletedStudents = originalStudentCount - studentsData.length;
            const deletedAttendance = originalAttendanceCount - attendanceData.length;
            const deletedGrades = originalGradeCount - gradesData.length;
            
            // Show success message
            let successMessage = `‚úÖ Berhasil menghapus semua siswa dari kelas ${selectedClass}!\n\n`;
            successMessage += `üìä Data yang dihapus:\n`;
            successMessage += `‚Ä¢ ${deletedStudents} siswa\n`;
            if (deletedAttendance > 0) {
                successMessage += `‚Ä¢ ${deletedAttendance} data presensi\n`;
            }
            if (deletedGrades > 0) {
                successMessage += `‚Ä¢ ${deletedGrades} data nilai\n`;
            }
            
            alert(successMessage);
            
            // Reset filter to show all classes
            document.getElementById('filterStudentClass').value = '';
            updateStudentsList();
        }

        function downloadGradeTemplate(assessmentId) {
            const assessment = assessmentData.find(a => a.id === assessmentId);
            if (!assessment) {
                alert('Penilaian tidak ditemukan!');
                return;
            }
            
            const classStudents = studentsData.filter(s => s.class === assessment.class);
            
            let csvContent = "NISN,Nama,Nilai\n";
            classStudents.forEach(student => {
                // Include existing grade if available
                const existingGrade = gradesData.find(g => g.assessmentId === assessmentId && g.studentId === student.id);
                const score = existingGrade ? existingGrade.score : '';
                csvContent += `${student.nis},${student.name},${score}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `template_nilai_${assessment.name.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function uploadGradeCSV(event, assessmentId) {
            const file = event.target.files[0];
            if (!file) return;
            
            const assessment = assessmentData.find(a => a.id === assessmentId);
            if (!assessment) {
                alert('Penilaian tidak ditemukan!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length < 2) {
                    alert('File CSV kosong atau tidak valid!');
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Validate headers
                const expectedHeaders = ['NISN', 'Nama', 'Nilai'];
                const isValidFormat = expectedHeaders.every(header => 
                    headers.some(h => h.toLowerCase() === header.toLowerCase())
                );
                
                if (!isValidFormat) {
                    alert('Format CSV tidak sesuai! Pastikan header: NISN,Nama,Nilai');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Process each line
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    
                    if (values.length < 3) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Data tidak lengkap`);
                        continue;
                    }
                    
                    const [nisn, nama, nilai] = values;
                    
                    // Find student by NISN
                    const student = studentsData.find(s => s.nis === nisn && s.class === assessment.class);
                    if (!student) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: NISN ${nisn} tidak ditemukan di kelas ${assessment.class}`);
                        continue;
                    }
                    
                    // Validate grade
                    if (nilai === '' || nilai === null || nilai === undefined) {
                        // Skip empty grades
                        continue;
                    }
                    
                    const score = parseFloat(nilai);
                    if (isNaN(score) || score < 0 || score > 100) {
                        errorCount++;
                        errors.push(`Baris ${i + 1}: Nilai harus berupa angka 0-100`);
                        continue;
                    }
                    
                    // Remove existing grade for same student and assessment
                    gradesData = gradesData.filter(g => 
                        !(g.assessmentId === assessmentId && g.studentId === student.id)
                    );
                    
                    // Add new grade
                    const gradeRecord = {
                        id: Date.now() + student.id + i,
                        assessmentId: assessmentId,
                        studentId: student.id,
                        studentName: student.name,
                        score: score,
                        inputDate: new Date().toISOString().split('T')[0]
                    };
                    
                    gradesData.push(gradeRecord);
                    successCount++;
                }
                
                // Save data
                saveData();
                
                // Show results
                let message = `Import nilai selesai!\n‚úÖ Berhasil: ${successCount} nilai`;
                if (errorCount > 0) {
                    message += `\n‚ùå Error: ${errorCount} baris`;
                    if (errors.length > 0) {
                        message += '\n\nDetail error:\n' + errors.slice(0, 5).join('\n');
                        if (errors.length > 5) {
                            message += `\n... dan ${errors.length - 5} error lainnya`;
                        }
                    }
                }
                
                alert(message);
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Settings functions
        function updateWeightDisplay() {
            const total = parseInt(document.getElementById('weightTP').value) +
                         parseInt(document.getElementById('weightLM').value) +
                         parseInt(document.getElementById('weightSTS').value) +
                         parseInt(document.getElementById('weightSAS').value);
            
            document.getElementById('totalWeight').textContent = total;
            
            // Add event listeners to weight inputs
            ['weightTP', 'weightLM', 'weightSTS', 'weightSAS'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateWeightDisplay);
            });
        }

        function saveWeightSettings(event) {
            event.preventDefault();
            
            const total = parseInt(document.getElementById('weightTP').value) +
                         parseInt(document.getElementById('weightLM').value) +
                         parseInt(document.getElementById('weightSTS').value) +
                         parseInt(document.getElementById('weightSAS').value);
            
            if (total !== 100) {
                alert('Total bobot harus 100%!');
                return;
            }
            
            weightSettings = {
                TP: parseInt(document.getElementById('weightTP').value),
                LM: parseInt(document.getElementById('weightLM').value),
                STS: parseInt(document.getElementById('weightSTS').value),
                SAS: parseInt(document.getElementById('weightSAS').value)
            };
            
            saveData();
            alert('Pengaturan bobot berhasil disimpan!');
        }

        function updatePredicateInputs() {
            document.getElementById('predicateA_min').value = predicateSettings.A.min;
            document.getElementById('predicateA_max').value = predicateSettings.A.max;
            document.getElementById('predicateB_min').value = predicateSettings.B.min;
            document.getElementById('predicateB_max').value = predicateSettings.B.max;
            document.getElementById('predicateC_min').value = predicateSettings.C.min;
            document.getElementById('predicateC_max').value = predicateSettings.C.max;
            document.getElementById('predicateD_min').value = predicateSettings.D.min;
            document.getElementById('predicateD_max').value = predicateSettings.D.max;
        }

        function savePredicateSettings(event) {
            event.preventDefault();
            
            const newPredicates = {
                A: {
                    min: parseInt(document.getElementById('predicateA_min').value),
                    max: parseInt(document.getElementById('predicateA_max').value),
                    label: 'Sangat Baik'
                },
                B: {
                    min: parseInt(document.getElementById('predicateB_min').value),
                    max: parseInt(document.getElementById('predicateB_max').value),
                    label: 'Baik'
                },
                C: {
                    min: parseInt(document.getElementById('predicateC_min').value),
                    max: parseInt(document.getElementById('predicateC_max').value),
                    label: 'Cukup'
                },
                D: {
                    min: parseInt(document.getElementById('predicateD_min').value),
                    max: parseInt(document.getElementById('predicateD_max').value),
                    label: 'Perlu Bimbingan'
                }
            };
            
            // Validate ranges
            const ranges = [
                { grade: 'A', min: newPredicates.A.min, max: newPredicates.A.max },
                { grade: 'B', min: newPredicates.B.min, max: newPredicates.B.max },
                { grade: 'C', min: newPredicates.C.min, max: newPredicates.C.max },
                { grade: 'D', min: newPredicates.D.min, max: newPredicates.D.max }
            ];
            
            // Check if min <= max for each range
            for (let range of ranges) {
                if (range.min > range.max) {
                    alert(`Predikat ${range.grade}: Nilai minimum tidak boleh lebih besar dari maksimum!`);
                    return;
                }
            }
            
            // Check for overlaps (simplified check)
            let allValues = [];
            for (let range of ranges) {
                for (let i = range.min; i <= range.max; i++) {
                    if (allValues.includes(i)) {
                        alert('Terdapat tumpang tindih dalam rentang nilai! Pastikan setiap nilai hanya masuk dalam satu predikat.');
                        return;
                    }
                    allValues.push(i);
                }
            }
            
            predicateSettings = newPredicates;
            saveData();
            alert('Pengaturan predikat berhasil disimpan!');
        }

        function getPredicateFromScore(score) {
            for (let grade in predicateSettings) {
                const predicate = predicateSettings[grade];
                if (score >= predicate.min && score <= predicate.max) {
                    return { grade: grade, label: predicate.label };
                }
            }
            return { grade: 'E', label: 'Tidak Memenuhi' };
        }

        function backupData() {
            const allData = {
                classes: classesData,
                students: studentsData,
                attendance: attendanceData,
                attendanceHistory: attendanceHistoryData,
                journal: journalData,
                assessment: assessmentData,
                grades: gradesData,
                weights: weightSettings,
                predicates: predicateSettings,
                website: websiteSettings
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_sekolah_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('Backup data berhasil didownload!');
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                alert('File harus berformat JSON!');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup data structure
                    const requiredKeys = ['classes', 'students', 'attendance', 'journal', 'assessment', 'grades', 'weights'];
                    const isValidBackup = requiredKeys.every(key => backupData.hasOwnProperty(key));
                    
                    if (!isValidBackup) {
                        alert('File backup tidak valid! Pastikan file adalah hasil backup dari sistem ini.');
                        event.target.value = '';
                        return;
                    }
                    
                    // Confirm restore
                    const confirmRestore = confirm('PERINGATAN: Restore akan mengganti SEMUA data yang ada dengan data dari backup. Apakah Anda yakin?');
                    if (!confirmRestore) {
                        event.target.value = '';
                        return;
                    }
                    
                    const doubleConfirm = confirm('Konfirmasi sekali lagi: Ganti semua data dengan data backup?');
                    if (!doubleConfirm) {
                        event.target.value = '';
                        return;
                    }
                    
                    // Restore data
                    classesData = backupData.classes || [];
                    studentsData = backupData.students || [];
                    attendanceData = backupData.attendance || [];
                    attendanceHistoryData = backupData.attendanceHistory || [];
                    journalData = backupData.journal || [];
                    assessmentData = backupData.assessment || [];
                    gradesData = backupData.grades || [];
                    weightSettings = backupData.weights || {
                        TP: 30,
                        LM: 30,
                        STS: 20,
                        SAS: 20
                    };
                    
                    // Restore predicate settings if available
                    if (backupData.predicates) {
                        predicateSettings = backupData.predicates;
                    }
                    
                    // Restore website settings if available
                    if (backupData.website) {
                        websiteSettings = backupData.website;
                    }
                    
                    // Save restored data
                    saveData();
                    
                    // Update all displays
                    updateClassViews();
                    updateAllClassOptions();
                    updateStudentsList();
                    updateJournalList();
                    updateAssessmentList();
                    updateAttendanceHistory();
                    updateDashboard();
                    
                    // Update weight inputs
                    document.getElementById('weightTP').value = weightSettings.TP;
                    document.getElementById('weightLM').value = weightSettings.LM;
                    document.getElementById('weightSTS').value = weightSettings.STS;
                    document.getElementById('weightSAS').value = weightSettings.SAS;
                    updateWeightDisplay();
                    
                    // Update predicate inputs
                    updatePredicateInputs();
                    
                    // Update website name display
                    updateWebsiteNameDisplay();
                    
                    alert('Data berhasil dipulihkan dari backup!');
                    
                } catch (error) {
                    alert('Error membaca file backup: ' + error.message);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function resetData() {
            const confirmReset = confirm('PERINGATAN: Ini akan menghapus SEMUA data dan tidak dapat dibatalkan. Apakah Anda yakin?');
            if (confirmReset) {
                const doubleConfirm = confirm('Konfirmasi sekali lagi: Hapus SEMUA data?');
                if (doubleConfirm) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }



        // Rekap Nilai functions
        function generateRekapNilai() {
            const selectedClass = document.getElementById('rekapNilaiClass').value;
            const selectedType = document.getElementById('rekapNilaiType').value;
            
            if (!selectedClass) {
                alert('Pilih kelas terlebih dahulu!');
                return;
            }
            
            const classStudents = studentsData.filter(s => s.class === selectedClass);
            let filteredAssessments = assessmentData.filter(a => a.class === selectedClass);
            
            if (selectedType) {
                filteredAssessments = filteredAssessments.filter(a => a.type === selectedType);
            }
            
            if (filteredAssessments.length === 0) {
                alert('Tidak ada penilaian yang ditemukan untuk kelas dan tipe yang dipilih!');
                return;
            }
            
            const rekapTable = document.getElementById('rekapNilaiTable');
            let tableHTML = `
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-2 text-left">NISN</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Nama Siswa</th>
            `;
            
            // Add assessment columns
            filteredAssessments.forEach(assessment => {
                tableHTML += `<th class="border border-gray-300 px-3 py-2 text-center">${assessment.name}<br><span class="text-xs text-gray-600">(${assessment.type})</span></th>`;
            });
            
            // Add average column
            tableHTML += `<th class="border border-gray-300 px-4 py-2 text-center bg-blue-50">Rata-rata</th>`;
            
            tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            classStudents.forEach(student => {
                let totalScore = 0;
                let scoreCount = 0;
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2 font-medium">${student.nis}</td>
                        <td class="border border-gray-300 px-4 py-2">${student.name}</td>
                `;
                
                filteredAssessments.forEach(assessment => {
                    const grade = gradesData.find(g => g.assessmentId === assessment.id && g.studentId === student.id);
                    const score = grade ? grade.score : '-';
                    
                    if (score !== '-') {
                        totalScore += parseFloat(score);
                        scoreCount++;
                    }
                    
                    let scoreClass = '';
                    if (score !== '-') {
                        if (score >= 85) scoreClass = 'bg-green-100 text-green-800';
                        else if (score >= 70) scoreClass = 'bg-yellow-100 text-yellow-800';
                        else scoreClass = 'bg-red-100 text-red-800';
                    }
                    
                    tableHTML += `<td class="border border-gray-300 px-3 py-2 text-center ${scoreClass}">${score}</td>`;
                });
                
                // Calculate average
                const average = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : '-';
                let avgClass = '';
                if (average !== '-') {
                    if (average >= 85) avgClass = 'bg-green-100 text-green-800 font-bold';
                    else if (average >= 70) avgClass = 'bg-yellow-100 text-yellow-800 font-bold';
                    else avgClass = 'bg-red-100 text-red-800 font-bold';
                }
                
                tableHTML += `<td class="border border-gray-300 px-4 py-2 text-center ${avgClass}">${average}</td>`;
                tableHTML += `</tr>`;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            rekapTable.innerHTML = tableHTML;
            document.getElementById('rekapNilaiResults').classList.remove('hidden');
        }

        function calculateFinalGrades() {
            const selectedClass = document.getElementById('rekapNilaiClass').value;
            
            if (!selectedClass) {
                alert('Generate rekap nilai terlebih dahulu!');
                return;
            }
            
            const classStudents = studentsData.filter(s => s.class === selectedClass);
            const classAssessments = assessmentData.filter(a => a.class === selectedClass);
            
            // Group assessments by type
            const assessmentsByType = {
                TP: classAssessments.filter(a => a.type === 'TP'),
                LM: classAssessments.filter(a => a.type === 'LM'),
                STS: classAssessments.filter(a => a.type === 'STS'),
                SAS: classAssessments.filter(a => a.type === 'SAS')
            };
            
            const finalGradesTable = document.getElementById('finalGradesTable');
            let tableHTML = `
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-2 text-left">NISN</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Nama Siswa</th>
                            <th class="border border-gray-300 px-3 py-2 text-center">TP<br><span class="text-xs">(${weightSettings.TP}%)</span></th>
                            <th class="border border-gray-300 px-3 py-2 text-center">LM<br><span class="text-xs">(${weightSettings.LM}%)</span></th>
                            <th class="border border-gray-300 px-3 py-2 text-center">STS<br><span class="text-xs">(${weightSettings.STS}%)</span></th>
                            <th class="border border-gray-300 px-3 py-2 text-center">SAS<br><span class="text-xs">(${weightSettings.SAS}%)</span></th>
                            <th class="border border-gray-300 px-4 py-2 text-center bg-blue-50">Nilai Akhir</th>
                            <th class="border border-gray-300 px-4 py-2 text-center bg-green-50">Predikat</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            classStudents.forEach(student => {
                const typeAverages = {};
                
                // Calculate average for each assessment type
                Object.keys(assessmentsByType).forEach(type => {
                    const typeAssessments = assessmentsByType[type];
                    if (typeAssessments.length > 0) {
                        let totalScore = 0;
                        let scoreCount = 0;
                        
                        typeAssessments.forEach(assessment => {
                            const grade = gradesData.find(g => g.assessmentId === assessment.id && g.studentId === student.id);
                            if (grade) {
                                totalScore += grade.score;
                                scoreCount++;
                            }
                        });
                        
                        typeAverages[type] = scoreCount > 0 ? totalScore / scoreCount : 0;
                    } else {
                        typeAverages[type] = 0;
                    }
                });
                
                // Calculate final grade with weights
                const finalGrade = (
                    (typeAverages.TP * weightSettings.TP / 100) +
                    (typeAverages.LM * weightSettings.LM / 100) +
                    (typeAverages.STS * weightSettings.STS / 100) +
                    (typeAverages.SAS * weightSettings.SAS / 100)
                ).toFixed(1);
                
                // Determine predicate using settings
                const predicateInfo = getPredicateFromScore(parseFloat(finalGrade));
                const predicate = predicateInfo.grade;
                const predicateLabel = predicateInfo.label;
                
                let predicateClass = '';
                switch(predicate) {
                    case 'A':
                        predicateClass = 'bg-green-100 text-green-800 font-bold';
                        break;
                    case 'B':
                        predicateClass = 'bg-blue-100 text-blue-800 font-bold';
                        break;
                    case 'C':
                        predicateClass = 'bg-yellow-100 text-yellow-800 font-bold';
                        break;
                    case 'D':
                        predicateClass = 'bg-orange-100 text-orange-800 font-bold';
                        break;
                    default:
                        predicateClass = 'bg-red-100 text-red-800 font-bold';
                }
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2 font-medium">${student.nis}</td>
                        <td class="border border-gray-300 px-4 py-2">${student.name}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center">${typeAverages.TP.toFixed(1)}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center">${typeAverages.LM.toFixed(1)}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center">${typeAverages.STS.toFixed(1)}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center">${typeAverages.SAS.toFixed(1)}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center font-bold text-lg">${finalGrade}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center ${predicateClass}" title="${predicateLabel}">${predicate}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            finalGradesTable.innerHTML = tableHTML;
            
            // Update weight display in the section header
            const weightDisplay = document.querySelector('#finalGradesSection .text-gray-600');
            if (weightDisplay) {
                weightDisplay.textContent = `Bobot: TP (${weightSettings.TP}%) ‚Ä¢ LM (${weightSettings.LM}%) ‚Ä¢ STS (${weightSettings.STS}%) ‚Ä¢ SAS (${weightSettings.SAS}%)`;
            }
            
            document.getElementById('finalGradesSection').classList.remove('hidden');
        }

        function exportRekapNilai() {
            const selectedClass = document.getElementById('rekapNilaiClass').value;
            const selectedType = document.getElementById('rekapNilaiType').value;
            
            if (!selectedClass) {
                alert('Generate rekap nilai terlebih dahulu!');
                return;
            }
            
            // Create CSV content
            let csvContent = "NISN,Nama Siswa";
            
            const classAssessments = assessmentData.filter(a => {
                if (selectedType) {
                    return a.class === selectedClass && a.type === selectedType;
                }
                return a.class === selectedClass;
            });
            
            classAssessments.forEach(assessment => {
                csvContent += `,${assessment.name} (${assessment.type})`;
            });
            csvContent += ",Rata-rata\n";
            
            const classStudents = studentsData.filter(s => s.class === selectedClass);
            
            classStudents.forEach(student => {
                csvContent += `${student.nis},${student.name}`;
                
                let totalScore = 0;
                let scoreCount = 0;
                
                classAssessments.forEach(assessment => {
                    const grade = gradesData.find(g => g.assessmentId === assessment.id && g.studentId === student.id);
                    const score = grade ? grade.score : '';
                    csvContent += `,${score}`;
                    
                    if (score !== '') {
                        totalScore += parseFloat(score);
                        scoreCount++;
                    }
                });
                
                const average = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : '';
                csvContent += `,${average}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rekap_nilai_${selectedClass}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Website name management functions
        function updateWebsiteNameDisplay() {
            // Update all website name displays
            const websiteName = websiteSettings.name;
            
            // Update login page title
            const loginTitle = document.querySelector('#loginContainer h1');
            if (loginTitle) {
                loginTitle.textContent = websiteName;
            }
            
            // Update sidebar title
            const sidebarTitle = document.querySelector('.w-64 h1');
            if (sidebarTitle) {
                sidebarTitle.textContent = websiteName;
            }
            
            // Update page title
            document.title = `${websiteName} - Sistem Manajemen Pembelajaran`;
            
            // Update current website name input
            const currentWebsiteNameInput = document.getElementById('currentWebsiteName');
            if (currentWebsiteNameInput) {
                currentWebsiteNameInput.value = websiteName;
            }
        }

        function changeWebsiteName(event) {
            event.preventDefault();
            
            const newWebsiteName = document.getElementById('newWebsiteName').value.trim();
            
            if (newWebsiteName.length < 3) {
                alert('Nama website harus minimal 3 karakter!');
                return;
            }
            
            if (newWebsiteName.length > 50) {
                alert('Nama website maksimal 50 karakter!');
                return;
            }
            
            // Confirm change
            const confirmChange = confirm(`Apakah Anda yakin ingin mengubah nama website menjadi "${newWebsiteName}"?`);
            
            if (!confirmChange) {
                return;
            }
            
            // Update website name
            websiteSettings.name = newWebsiteName;
            
            // Save to localStorage
            saveData();
            
            // Update all displays
            updateWebsiteNameDisplay();
            
            // Clear form
            document.getElementById('newWebsiteName').value = '';
            
            // Show success message
            alert(`Nama website berhasil diubah menjadi "${newWebsiteName}"!`);
        }

        // Login credential management functions
        function updateCurrentCredentialsDisplay() {
            const currentUsernameElement = document.getElementById('currentUsername');
            if (currentUsernameElement) {
                currentUsernameElement.textContent = AUTH_CREDENTIALS.username;
            }
        }

        function changeLoginCredentials(event) {
            event.preventDefault();
            
            const newUsername = document.getElementById('newUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (newUsername.length < 3) {
                alert('Username harus minimal 3 karakter!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password harus minimal 6 karakter!');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Konfirmasi password tidak cocok!');
                return;
            }
            
            // Double confirmation
            const confirmChange = confirm(`Apakah Anda yakin ingin mengubah kredensial login?\n\nUsername baru: ${newUsername}\n\nSetelah perubahan, Anda akan otomatis logout dan harus login kembali dengan kredensial baru.`);
            
            if (!confirmChange) {
                return;
            }
            
            const doubleConfirm = confirm('Konfirmasi sekali lagi: Ubah kredensial login dan logout otomatis?');
            
            if (!doubleConfirm) {
                return;
            }
            
            // Update credentials
            AUTH_CREDENTIALS.username = newUsername;
            AUTH_CREDENTIALS.password = newPassword;
            
            // Save to localStorage
            saveData();
            
            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // Update display
            updateCurrentCredentialsDisplay();
            
            // Show success message
            alert('Kredensial login berhasil diubah!\n\nSistem akan logout otomatis. Silakan login kembali dengan kredensial baru.');
            
            // Auto logout after short delay
            setTimeout(() => {
                handleLogout();
            }, 1000);
        }

        // Sidebar toggle functionality
        let sidebarCollapsed = false;
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('toggleIcon');
            const menuItems = document.querySelectorAll('.sidebar-item');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                toggleIcon.textContent = '‚ñ∂';
                toggleIcon.parentElement.title = 'Tampilkan Menu';
                
                // Add tooltips to menu items
                menuItems.forEach(item => {
                    const menuText = item.querySelector('.menu-text');
                    if (menuText) {
                        item.classList.add('tooltip-enabled');
                        item.setAttribute('data-tooltip', menuText.textContent);
                    }
                });
            } else {
                sidebar.classList.remove('collapsed');
                toggleIcon.textContent = '‚óÄ';
                toggleIcon.parentElement.title = 'Sembunyikan Menu';
                
                // Remove tooltips from menu items
                menuItems.forEach(item => {
                    item.classList.remove('tooltip-enabled');
                    item.removeAttribute('data-tooltip');
                });
            }
            
            // Save sidebar state
            localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
        }
        
        function initSidebarState() {
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                toggleSidebar();
            }
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            checkAuthentication();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9957d9c057bf514a',t:'MTc2MTYyNzQyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
